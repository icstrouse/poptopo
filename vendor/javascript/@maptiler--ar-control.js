// @maptiler/ar-control@3.0.2 downloaded from https://ga.jspm.io/npm:@maptiler/ar-control@3.0.2/dist/maptiler-ar-control.js

import{math as t,LngLat as e}from"@maptiler/sdk";import{ModelViewerElement as r}from"@google/model-viewer";import{Filesystem as s,Directory as i}from"@capacitor/filesystem";import{Capacitor as l}from"@capacitor/core";import{FileOpener as c}from"@capacitor-community/file-opener";import h from"events";import*as u from"three";import{PlaneGeometry as p,ShaderMaterial as m,Uniform as d,SRGBColorSpace as f,Mesh as g,PerspectiveCamera as x,Scene as w,WebGLRenderer as L,CanvasTexture as y,NearestFilter as C,NearestMipmapNearestFilter as M,NearestMipmapLinearFilter as T,LinearFilter as b,LinearMipmapNearestFilter as v,LinearMipmapLinearFilter as S,ClampToEdgeWrapping as I,RepeatWrapping as _,MirroredRepeatWrapping as R,Color as D,MathUtils as N,Vector3 as U,CompressedTexture as B,Source as F,NoColorSpace as O,RGBAFormat as P,DoubleSide as $,BufferAttribute as z,PropertyBinding as Z,InterpolateDiscrete as G,Matrix4 as H,Quaternion as V,InterpolateLinear as j}from"three";var Y=Object.defineProperty;var Et=(t,e,r)=>e in t?Y(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r;var E=(t,e,r)=>(Et(t,typeof e!="symbol"?e+"":e,r),r)
/* @license
 * Copyright 2019 Google LLC. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the 'License');
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an 'AS IS' BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */;const X=navigator.xr!=null&&self.XRSession!=null&&navigator.xr.isSessionSupported!=null;var K;const q=X&&self.XRSession&&((K=self.XRSession)==null?void 0:K.requestHitTestSource)!=null,J=self.ResizeObserver!=null,Q=self.IntersectionObserver!=null,tt=q,it=(()=>{const t=navigator.userAgent||navigator.vendor||self.opera;let e=!1;return(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino/i.test(t)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(t.substr(0,4)))&&(e=!0),e})(),at=/\bCrOS\b/.test(navigator.userAgent),ot=/android/i.test(navigator.userAgent),lt=/iPad|iPhone|iPod/.test(navigator.userAgent)&&!self.MSStream||navigator.platform==="MacIntel"&&navigator.maxTouchPoints>1,ct=/Safari\//.test(navigator.userAgent),ht=/firefox/i.test(navigator.userAgent),ut=/OculusBrowser/.test(navigator.userAgent),ft=lt&&/CriOS\//.test(navigator.userAgent),gt=lt&&ct,Lt=ot&&!ht&&!ut,Tt=!!(window.webkit&&window.webkit.messageHandlers),bt=(()=>{if(lt){if(Tt)return!!/CriOS\/|EdgiOS\/|FxiOS\/|GSA\/|DuckDuckGo\//.test(navigator.userAgent);{const t=document.createElement("a");return!!(t.relList&&t.relList.supports&&t.relList.supports("ar"))}}return!1})();let St,It,_t,Rt;function pe(t,e=1/0,r=null){It||(It=new p(2,2,1,1)),_t||(_t=new m({uniforms:{blitTexture:new d(t)},vertexShader:"\n\t\t\tvarying vec2 vUv;\n\t\t\tvoid main(){\n\t\t\t\tvUv = uv;\n\t\t\t\tgl_Position = vec4(position.xy * 1.0,0.,.999999);\n\t\t\t}",fragmentShader:"\n\t\t\tuniform sampler2D blitTexture; \n\t\t\tvarying vec2 vUv;\n\n\t\t\tvoid main(){ \n\t\t\t\tgl_FragColor = vec4(vUv.xy, 0, 1);\n\t\t\t\t\n\t\t\t\t#ifdef IS_SRGB\n\t\t\t\tgl_FragColor = LinearTosRGB( texture2D( blitTexture, vUv) );\n\t\t\t\t#else\n\t\t\t\tgl_FragColor = texture2D( blitTexture, vUv);\n\t\t\t\t#endif\n\t\t\t}"})),_t.uniforms.blitTexture.value=t,_t.defines.IS_SRGB=t.colorSpace==f,_t.needsUpdate=!0,Rt||(Rt=new g(It,_t),Rt.frustumCulled=!1);const s=new x,i=new w;i.add(Rt),r===null&&(r=St=new L({antialias:!1}));const l=Math.min(t.image.width,e),c=Math.min(t.image.height,e);r.setSize(l,c),r.clear(),r.render(i,s);const h=document.createElement("canvas"),u=h.getContext("2d");h.width=l,h.height=c,u.drawImage(r.domElement,0,0,l,c);const C=new y(h);return C.minFilter=t.minFilter,C.magFilter=t.magFilter,C.wrapS=t.wrapS,C.wrapT=t.wrapT,C.name=t.name,St&&(St.forceContextLoss(),St.dispose(),St=null),C}const At={POSITION:["byte","byte normalized","unsigned byte","unsigned byte normalized","short","short normalized","unsigned short","unsigned short normalized"],NORMAL:["byte normalized","short normalized"],TANGENT:["byte normalized","short normalized"],TEXCOORD:["byte","byte normalized","unsigned byte","short","short normalized","unsigned short"]};class ke{constructor(){this.pluginCallbacks=[],this.register((function(t){return new Cn(t)})),this.register((function(t){return new yn(t)})),this.register((function(t){return new Tn(t)})),this.register((function(t){return new bn(t)})),this.register((function(t){return new En(t)})),this.register((function(t){return new Sn(t)})),this.register((function(t){return new Mn(t)})),this.register((function(t){return new vn(t)})),this.register((function(t){return new In(t)})),this.register((function(t){return new An(t)})),this.register((function(t){return new _n(t)})),this.register((function(t){return new Rn(t)})),this.register((function(t){return new Dn(t)}))}register(t){return this.pluginCallbacks.indexOf(t)===-1&&this.pluginCallbacks.push(t),this}unregister(t){return this.pluginCallbacks.indexOf(t)!==-1&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(t),1),this
/**
   * Parse scenes and generate GLTF output
   * @param  {Scene or [THREE.Scenes]} input   Scene or Array of THREE.Scenes
   * @param  {Function} onDone  Callback on completed
   * @param  {Function} onError  Callback on errors
   * @param  {Object} options options
   */}parse(t,e,r,s){const i=new Ln,l=[];for(let t=0,e=this.pluginCallbacks.length;t<e;t++)l.push(this.pluginCallbacks[t](i));i.setPlugins(l),i.write(t,e,s).catch(r)}parseAsync(t,e){const r=this;return new Promise((function(s,i){r.parse(t,s,i,e)}))}}const Dt={POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6,BYTE:5120,UNSIGNED_BYTE:5121,SHORT:5122,UNSIGNED_SHORT:5123,INT:5124,UNSIGNED_INT:5125,FLOAT:5126,ARRAY_BUFFER:34962,ELEMENT_ARRAY_BUFFER:34963,NEAREST:9728,LINEAR:9729,NEAREST_MIPMAP_NEAREST:9984,LINEAR_MIPMAP_NEAREST:9985,NEAREST_MIPMAP_LINEAR:9986,LINEAR_MIPMAP_LINEAR:9987,CLAMP_TO_EDGE:33071,MIRRORED_REPEAT:33648,REPEAT:10497},kt="KHR_mesh_quantization",Nt={};Nt[C]=Dt.NEAREST;Nt[M]=Dt.NEAREST_MIPMAP_NEAREST;Nt[T]=Dt.NEAREST_MIPMAP_LINEAR;Nt[b]=Dt.LINEAR;Nt[v]=Dt.LINEAR_MIPMAP_NEAREST;Nt[S]=Dt.LINEAR_MIPMAP_LINEAR;Nt[I]=Dt.CLAMP_TO_EDGE;Nt[_]=Dt.REPEAT;Nt[R]=Dt.MIRRORED_REPEAT;const Ut={scale:"scale",position:"translation",quaternion:"rotation",morphTargetInfluences:"weights"},Bt=new D,Ft=12,Ot=1179937895,Pt=2,$t=8,zt=1313821514,Zt=5130562;function ae(t,e){return t.length===e.length&&t.every((function(t,r){return t===e[r]}))}function mn(t){return(new TextEncoder).encode(t).buffer}function xn(t){return ae(t.elements,[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])}function wn(t,e,r){const s={min:new Array(t.itemSize).fill(Number.POSITIVE_INFINITY),max:new Array(t.itemSize).fill(Number.NEGATIVE_INFINITY)};for(let i=e;i<e+r;i++)for(let e=0;e<t.itemSize;e++){let r;t.itemSize>4?r=t.array[i*t.itemSize+e]:(e===0?r=t.getX(i):e===1?r=t.getY(i):e===2?r=t.getZ(i):e===3&&(r=t.getW(i)),t.normalized===!0&&(r=N.normalize(r,t.array))),s.min[e]=Math.min(s.min[e],r),s.max[e]=Math.max(s.max[e],r)}return s}function pt(t){return Math.ceil(t/4)*4}function Ee(t,e=0){const r=pt(t.byteLength);if(r!==t.byteLength){const s=new Uint8Array(r);if(s.set(new Uint8Array(t)),e!==0)for(let i=t.byteLength;i<r;i++)s[i]=e;return s.buffer}return t}function Xe(){return typeof document>"u"&&typeof OffscreenCanvas<"u"?new OffscreenCanvas(1,1):document.createElement("canvas")}function Ke(t,e){if(t.toBlob!==void 0)return new Promise((r=>t.toBlob(r,e)));let r;return e==="image/jpeg"?r=.92:e==="image/webp"&&(r=.8),t.convertToBlob({type:e,quality:r})}class Ln{constructor(){this.plugins=[],this.options={},this.pending=[],this.buffers=[],this.byteOffset=0,this.buffers=[],this.nodeMap=new Map,this.skins=[],this.extensionsUsed={},this.extensionsRequired={},this.uids=new Map,this.uid=0,this.json={asset:{version:"2.0",generator:"THREE.GLTFExporter"}},this.cache={meshes:new Map,attributes:new Map,attributesNormalized:new Map,materials:new Map,textures:new Map,images:new Map}}setPlugins(t){this.plugins=t}
/**
   * Parse scenes and generate GLTF output
   * @param  {Scene or [THREE.Scenes]} input   Scene or Array of THREE.Scenes
   * @param  {Function} onDone  Callback on completed
   * @param  {Object} options options
   */async write(t,e,r={}){this.options=Object.assign({binary:!1,trs:!1,onlyVisible:!0,maxTextureSize:1/0,animations:[],includeCustomExtensions:!1},r),this.options.animations.length>0&&(this.options.trs=!0),this.processInput(t),await Promise.all(this.pending);const s=this,i=s.buffers,l=s.json;r=s.options;const c=s.extensionsUsed,h=s.extensionsRequired,u=new Blob(i,{type:"application/octet-stream"}),p=Object.keys(c),m=Object.keys(h);if(p.length>0&&(l.extensionsUsed=p),m.length>0&&(l.extensionsRequired=m),l.buffers&&l.buffers.length>0&&(l.buffers[0].byteLength=u.size),r.binary===!0){const t=new FileReader;t.readAsArrayBuffer(u),t.onloadend=function(){const r=Ee(t.result),s=new DataView(new ArrayBuffer($t));s.setUint32(0,r.byteLength,!0),s.setUint32(4,Zt,!0);const i=Ee(mn(JSON.stringify(l)),32),c=new DataView(new ArrayBuffer($t));c.setUint32(0,i.byteLength,!0),c.setUint32(4,zt,!0);const h=new ArrayBuffer(Ft),u=new DataView(h);u.setUint32(0,Ot,!0),u.setUint32(4,Pt,!0);const p=Ft+c.byteLength+i.byteLength+s.byteLength+r.byteLength;u.setUint32(8,p,!0);const m=new Blob([h,c,i,s,r],{type:"application/octet-stream"}),d=new FileReader;d.readAsArrayBuffer(m),d.onloadend=function(){e(d.result)}}}else if(l.buffers&&l.buffers.length>0){const t=new FileReader;t.readAsDataURL(u),t.onloadend=function(){const r=t.result;l.buffers[0].uri=r,e(l)}}else e(l)}
/**
   * Serializes a userData.
   *
   * @param {THREE.Object3D|THREE.Material} object
   * @param {Object} objectDef
   */serializeUserData(t,e){if(Object.keys(t.userData).length===0)return;const r=this.options,s=this.extensionsUsed;try{const i=JSON.parse(JSON.stringify(t.userData));if(r.includeCustomExtensions&&i.gltfExtensions){e.extensions===void 0&&(e.extensions={});for(const t in i.gltfExtensions)e.extensions[t]=i.gltfExtensions[t],s[t]=!0;delete i.gltfExtensions}Object.keys(i).length>0&&(e.extras=i)}catch(e){console.warn("THREE.GLTFExporter: userData of '"+t.name+"' won't be serialized because of JSON.stringify error - "+e.message)}}
/**
   * Returns ids for buffer attributes.
   * @param  {Object} object
   * @return {Integer}
   */getUID(t,e=!1){if(this.uids.has(t)===!1){const e=new Map;e.set(!0,this.uid++),e.set(!1,this.uid++),this.uids.set(t,e)}return this.uids.get(t).get(e)}
/**
   * Checks if normal attribute values are normalized.
   *
   * @param {BufferAttribute} normal
   * @returns {Boolean}
   */isNormalizedNormalAttribute(t){if(this.cache.attributesNormalized.has(t))return!1;const e=new U;for(let r=0,s=t.count;r<s;r++)if(Math.abs(e.fromBufferAttribute(t,r).length()-1)>5e-4)return!1;return!0}
/**
   * Creates normalized normal buffer attribute.
   *
   * @param {BufferAttribute} normal
   * @returns {BufferAttribute}
   *
   */createNormalizedNormalAttribute(t){const e=this.cache;if(e.attributesNormalized.has(t))return e.attributesNormalized.get(t);const r=t.clone(),s=new U;for(let t=0,e=r.count;t<e;t++)s.fromBufferAttribute(r,t),s.x===0&&s.y===0&&s.z===0?s.setX(1):s.normalize(),r.setXYZ(t,s.x,s.y,s.z);return e.attributesNormalized.set(t,r),r
/**
   * Applies a texture transform, if present, to the map definition. Requires
   * the KHR_texture_transform extension.
   *
   * @param {Object} mapDef
   * @param {THREE.Texture} texture
   */}applyTextureTransform(t,e){let r=!1;const s={};(e.offset.x!==0||e.offset.y!==0)&&(s.offset=e.offset.toArray(),r=!0),e.rotation!==0&&(s.rotation=e.rotation,r=!0),(e.repeat.x!==1||e.repeat.y!==1)&&(s.scale=e.repeat.toArray(),r=!0),r&&(t.extensions=t.extensions||{},t.extensions.KHR_texture_transform=s,this.extensionsUsed.KHR_texture_transform=!0)}buildMetalRoughTexture(t,e){if(t===e)return t;function n(t){return t.colorSpace===f?function(t){return t<.04045?t*.0773993808:Math.pow(t*.9478672986+.0521327014,2.4)}:function(t){return t}}console.warn("THREE.GLTFExporter: Merged metalnessMap and roughnessMap textures."),t instanceof B&&(t=pe(t)),e instanceof B&&(e=pe(e));const r=t?t.image:null,s=e?e.image:null,i=Math.max(r?r.width:0,s?s.width:0),l=Math.max(r?r.height:0,s?s.height:0),c=Xe();c.width=i,c.height=l;const h=c.getContext("2d");h.fillStyle="#00ffff",h.fillRect(0,0,i,l);const u=h.getImageData(0,0,i,l);if(r){h.drawImage(r,0,0,i,l);const e=n(t),s=h.getImageData(0,0,i,l).data;for(let t=2;t<s.length;t+=4)u.data[t]=e(s[t]/256)*256}if(s){h.drawImage(s,0,0,i,l);const t=n(e),r=h.getImageData(0,0,i,l).data;for(let e=1;e<r.length;e+=4)u.data[e]=t(r[e]/256)*256}h.putImageData(u,0,0);const p=(t||e).clone();return p.source=new F(c),p.colorSpace=O,p.channel=(t||e).channel,t&&e&&t.channel!==e.channel&&console.warn("THREE.GLTFExporter: UV channels for metalnessMap and roughnessMap textures must match."),p
/**
   * Process a buffer to append to the default one.
   * @param  {ArrayBuffer} buffer
   * @return {Integer}
   */}processBuffer(t){const e=this.json,r=this.buffers;return e.buffers||(e.buffers=[{byteLength:0}]),r.push(t),0
/**
   * Process and generate a BufferView
   * @param  {BufferAttribute} attribute
   * @param  {number} componentType
   * @param  {number} start
   * @param  {number} count
   * @param  {number} target (Optional) Target usage of the BufferView
   * @return {Object}
   */}processBufferView(t,e,r,s,i){const l=this.json;l.bufferViews||(l.bufferViews=[]);let c;switch(e){case Dt.BYTE:case Dt.UNSIGNED_BYTE:c=1;break;case Dt.SHORT:case Dt.UNSIGNED_SHORT:c=2;break;default:c=4}let h=t.itemSize*c;i===Dt.ARRAY_BUFFER&&(h=Math.ceil(h/4)*4);const u=pt(s*h),p=new DataView(new ArrayBuffer(u));let m=0;for(let i=r;i<r+s;i++){for(let r=0;r<t.itemSize;r++){let s;t.itemSize>4?s=t.array[i*t.itemSize+r]:(r===0?s=t.getX(i):r===1?s=t.getY(i):r===2?s=t.getZ(i):r===3&&(s=t.getW(i)),t.normalized===!0&&(s=N.normalize(s,t.array))),e===Dt.FLOAT?p.setFloat32(m,s,!0):e===Dt.INT?p.setInt32(m,s,!0):e===Dt.UNSIGNED_INT?p.setUint32(m,s,!0):e===Dt.SHORT?p.setInt16(m,s,!0):e===Dt.UNSIGNED_SHORT?p.setUint16(m,s,!0):e===Dt.BYTE?p.setInt8(m,s):e===Dt.UNSIGNED_BYTE&&p.setUint8(m,s),m+=c}m%h!==0&&(m+=h-m%h)}const d={buffer:this.processBuffer(p.buffer),byteOffset:this.byteOffset,byteLength:u};return i!==void 0&&(d.target=i),i===Dt.ARRAY_BUFFER&&(d.byteStride=h),this.byteOffset+=u,l.bufferViews.push(d),{id:l.bufferViews.length-1,byteLength:0}
/**
   * Process and generate a BufferView from an image Blob.
   * @param {Blob} blob
   * @return {Promise<Integer>}
   */}processBufferViewImage(t){const e=this,r=e.json;return r.bufferViews||(r.bufferViews=[]),new Promise((function(s){const i=new FileReader;i.readAsArrayBuffer(t),i.onloadend=function(){const t=Ee(i.result),l={buffer:e.processBuffer(t),byteOffset:e.byteOffset,byteLength:t.byteLength};e.byteOffset+=t.byteLength,s(r.bufferViews.push(l)-1)}}))
/**
   * Process attribute to generate an accessor
   * @param  {BufferAttribute} attribute Attribute to process
   * @param  {THREE.BufferGeometry} geometry (Optional) Geometry used for truncated draw range
   * @param  {Integer} start (Optional)
   * @param  {Integer} count (Optional)
   * @return {Integer|null} Index of the processed accessor on the "accessors" array
   */}processAccessor(t,e,r,s){const i=this.json,l={1:"SCALAR",2:"VEC2",3:"VEC3",4:"VEC4",9:"MAT3",16:"MAT4"};let c;if(t.array.constructor===Float32Array)c=Dt.FLOAT;else if(t.array.constructor===Int32Array)c=Dt.INT;else if(t.array.constructor===Uint32Array)c=Dt.UNSIGNED_INT;else if(t.array.constructor===Int16Array)c=Dt.SHORT;else if(t.array.constructor===Uint16Array)c=Dt.UNSIGNED_SHORT;else if(t.array.constructor===Int8Array)c=Dt.BYTE;else{if(t.array.constructor!==Uint8Array)throw new Error("THREE.GLTFExporter: Unsupported bufferAttribute component type: "+t.array.constructor.name);c=Dt.UNSIGNED_BYTE}if(r===void 0&&(r=0),(s===void 0||s===1/0)&&(s=t.count),s===0)return null;const h=wn(t,r,s);let u;e!==void 0&&(u=t===e.index?Dt.ELEMENT_ARRAY_BUFFER:Dt.ARRAY_BUFFER);const p=this.processBufferView(t,c,r,s,u),m={bufferView:p.id,byteOffset:p.byteOffset,componentType:c,count:s,max:h.max,min:h.min,type:l[t.itemSize]};return t.normalized===!0&&(m.normalized=!0),i.accessors||(i.accessors=[]),i.accessors.push(m)-1
/**
   * Process image
   * @param  {Image} image to process
   * @param  {Integer} format of the image (RGBAFormat)
   * @param  {Boolean} flipY before writing out the image
   * @param  {String} mimeType export format
   * @return {Integer}     Index of the processed texture in the "images" array
   */}processImage(t,e,r,s="image/png"){if(t!==null){const i=this,l=i.cache,c=i.json,h=i.options,u=i.pending;l.images.has(t)||l.images.set(t,{});const p=l.images.get(t),m=s+":flipY/"+r.toString();if(p[m]!==void 0)return p[m];c.images||(c.images=[]);const d={mimeType:s},f=Xe();f.width=Math.min(t.width,h.maxTextureSize),f.height=Math.min(t.height,h.maxTextureSize);const g=f.getContext("2d");if(r===!0&&(g.translate(0,f.height),g.scale(1,-1)),t.data!==void 0){e!==P&&console.error("GLTFExporter: Only RGBAFormat is supported.",e),(t.width>h.maxTextureSize||t.height>h.maxTextureSize)&&console.warn("GLTFExporter: Image size is bigger than maxTextureSize",t);const r=new Uint8ClampedArray(t.height*t.width*4);for(let e=0;e<r.length;e+=4)r[e+0]=t.data[e+0],r[e+1]=t.data[e+1],r[e+2]=t.data[e+2],r[e+3]=t.data[e+3];g.putImageData(new ImageData(r,t.width,t.height),0,0)}else{if(!(typeof HTMLImageElement<"u"&&t instanceof HTMLImageElement||typeof HTMLCanvasElement<"u"&&t instanceof HTMLCanvasElement||typeof ImageBitmap<"u"&&t instanceof ImageBitmap||typeof OffscreenCanvas<"u"&&t instanceof OffscreenCanvas))throw new Error("THREE.GLTFExporter: Invalid image type. Use HTMLImageElement, HTMLCanvasElement, ImageBitmap or OffscreenCanvas.");g.drawImage(t,0,0,f.width,f.height)}h.binary===!0?u.push(Ke(f,s).then((t=>i.processBufferViewImage(t))).then((t=>{d.bufferView=t}))):f.toDataURL!==void 0?d.uri=f.toDataURL(s):u.push(Ke(f,s).then((t=>(new FileReader).readAsDataURL(t))).then((t=>{d.uri=t})));const x=c.images.push(d)-1;return p[m]=x,x}throw new Error("THREE.GLTFExporter: No valid image data found. Unable to process texture.")}
/**
   * Process sampler
   * @param  {Texture} map Texture to process
   * @return {Integer}     Index of the processed texture in the "samplers" array
   */processSampler(t){const e=this.json;e.samplers||(e.samplers=[]);const r={magFilter:Nt[t.magFilter],minFilter:Nt[t.minFilter],wrapS:Nt[t.wrapS],wrapT:Nt[t.wrapT]};return e.samplers.push(r)-1}
/**
   * Process texture
   * @param  {Texture} map Map to process
   * @return {Integer} Index of the processed texture in the "textures" array
   */processTexture(t){const e=this.options,r=this.cache,s=this.json;if(r.textures.has(t))return r.textures.get(t);s.textures||(s.textures=[]),t instanceof B&&(t=pe(t,e.maxTextureSize));let i=t.userData.mimeType;i==="image/webp"&&(i="image/png");const l={sampler:this.processSampler(t),source:this.processImage(t.image,t.format,t.flipY,i)};t.name&&(l.name=t.name),this._invokeAll((function(e){e.writeTexture&&e.writeTexture(t,l)}));const c=s.textures.push(l)-1;return r.textures.set(t,c),c
/**
   * Process material
   * @param  {THREE.Material} material Material to process
   * @return {Integer|null} Index of the processed material in the "materials" array
   */}processMaterial(t){const e=this.cache,r=this.json;if(e.materials.has(t))return e.materials.get(t);if(t.isShaderMaterial)return console.warn("GLTFExporter: THREE.ShaderMaterial not supported."),null;r.materials||(r.materials=[]);const s={pbrMetallicRoughness:{}};t.isMeshStandardMaterial!==!0&&t.isMeshBasicMaterial!==!0&&console.warn("GLTFExporter: Use MeshStandardMaterial or MeshBasicMaterial for best results.");const i=t.color.toArray().concat([t.opacity]);if(ae(i,[1,1,1,1])||(s.pbrMetallicRoughness.baseColorFactor=i),t.isMeshStandardMaterial?(s.pbrMetallicRoughness.metallicFactor=t.metalness,s.pbrMetallicRoughness.roughnessFactor=t.roughness):(s.pbrMetallicRoughness.metallicFactor=.5,s.pbrMetallicRoughness.roughnessFactor=.5),t.metalnessMap||t.roughnessMap){const e=this.buildMetalRoughTexture(t.metalnessMap,t.roughnessMap),r={index:this.processTexture(e),channel:e.channel};this.applyTextureTransform(r,e),s.pbrMetallicRoughness.metallicRoughnessTexture=r}if(t.map){const e={index:this.processTexture(t.map),texCoord:t.map.channel};this.applyTextureTransform(e,t.map),s.pbrMetallicRoughness.baseColorTexture=e}if(t.emissive){const e=t.emissive;if(Math.max(e.r,e.g,e.b)>0&&(s.emissiveFactor=t.emissive.toArray()),t.emissiveMap){const e={index:this.processTexture(t.emissiveMap),texCoord:t.emissiveMap.channel};this.applyTextureTransform(e,t.emissiveMap),s.emissiveTexture=e}}if(t.normalMap){const e={index:this.processTexture(t.normalMap),texCoord:t.normalMap.channel};t.normalScale&&t.normalScale.x!==1&&(e.scale=t.normalScale.x),this.applyTextureTransform(e,t.normalMap),s.normalTexture=e}if(t.aoMap){const e={index:this.processTexture(t.aoMap),texCoord:t.aoMap.channel};t.aoMapIntensity!==1&&(e.strength=t.aoMapIntensity),this.applyTextureTransform(e,t.aoMap),s.occlusionTexture=e}t.transparent?s.alphaMode="BLEND":t.alphaTest>0&&(s.alphaMode="MASK",s.alphaCutoff=t.alphaTest),t.side===$&&(s.doubleSided=!0),t.name!==""&&(s.name=t.name),this.serializeUserData(t,s),this._invokeAll((function(e){e.writeMaterial&&e.writeMaterial(t,s)}));const l=r.materials.push(s)-1;return e.materials.set(t,l),l
/**
   * Process mesh
   * @param  {THREE.Mesh} mesh Mesh to process
   * @return {Integer|null} Index of the processed mesh in the "meshes" array
   */}processMesh(t){const e=this.cache,r=this.json,s=[t.geometry.uuid];if(Array.isArray(t.material))for(let e=0,r=t.material.length;e<r;e++)s.push(t.material[e].uuid);else s.push(t.material.uuid);const i=s.join(":");if(e.meshes.has(i))return e.meshes.get(i);const l=t.geometry;let c;c=t.isLineSegments?Dt.LINES:t.isLineLoop?Dt.LINE_LOOP:t.isLine?Dt.LINE_STRIP:t.isPoints?Dt.POINTS:t.material.wireframe?Dt.LINES:Dt.TRIANGLES;const h={},u={},p=[],m=[],d={uv:"TEXCOORD_0",uv1:"TEXCOORD_1",uv2:"TEXCOORD_2",uv3:"TEXCOORD_3",color:"COLOR_0",skinWeight:"WEIGHTS_0",skinIndex:"JOINTS_0"},f=l.getAttribute("normal");f!==void 0&&!this.isNormalizedNormalAttribute(f)&&(console.warn("THREE.GLTFExporter: Creating normalized normal attribute from the non-normalized one."),l.setAttribute("normal",this.createNormalizedNormalAttribute(f)));let g=null;for(let t in l.attributes){if(t.slice(0,5)==="morph")continue;const r=l.attributes[t];if(t=d[t]||t.toUpperCase(),/^(POSITION|NORMAL|TANGENT|TEXCOORD_\d+|COLOR_\d+|JOINTS_\d+|WEIGHTS_\d+)$/.test(t)||(t="_"+t),e.attributes.has(this.getUID(r))){u[t]=e.attributes.get(this.getUID(r));continue}g=null;const s=r.array;t==="JOINTS_0"&&!(s instanceof Uint16Array)&&!(s instanceof Uint8Array)&&(console.warn('GLTFExporter: Attribute "skinIndex" converted to type UNSIGNED_SHORT.'),g=new z(new Uint16Array(s),r.itemSize,r.normalized));const i=this.processAccessor(g||r,l);i!==null&&(t.startsWith("_")||this.detectMeshQuantization(t,r),u[t]=i,e.attributes.set(this.getUID(r),i))}if(f!==void 0&&l.setAttribute("normal",f),Object.keys(u).length===0)return null;if(t.morphTargetInfluences!==void 0&&t.morphTargetInfluences.length>0){const r=[],s=[],i={};if(t.morphTargetDictionary!==void 0)for(const e in t.morphTargetDictionary)i[t.morphTargetDictionary[e]]=e;for(let c=0;c<t.morphTargetInfluences.length;++c){const h={};let u=!1;for(const t in l.morphAttributes){if(t!=="position"&&t!=="normal"){u||(console.warn("GLTFExporter: Only POSITION and NORMAL morph are supported."),u=!0);continue}const r=l.morphAttributes[t][c],s=t.toUpperCase(),i=l.attributes[t];if(e.attributes.has(this.getUID(r,!0))){h[s]=e.attributes.get(this.getUID(r,!0));continue}const p=r.clone();if(!l.morphTargetsRelative)for(let t=0,e=r.count;t<e;t++)for(let e=0;e<r.itemSize;e++)e===0&&p.setX(t,r.getX(t)-i.getX(t)),e===1&&p.setY(t,r.getY(t)-i.getY(t)),e===2&&p.setZ(t,r.getZ(t)-i.getZ(t)),e===3&&p.setW(t,r.getW(t)-i.getW(t));h[s]=this.processAccessor(p,l),e.attributes.set(this.getUID(i,!0),h[s])}m.push(h),r.push(t.morphTargetInfluences[c]),t.morphTargetDictionary!==void 0&&s.push(i[c])}h.weights=r,s.length>0&&(h.extras={},h.extras.targetNames=s)}const x=Array.isArray(t.material);if(x&&l.groups.length===0)return null;let w=!1;if(x&&l.index===null){const t=[];for(let e=0,r=l.attributes.position.count;e<r;e++)t[e]=e;l.setIndex(t),w=!0}const L=x?t.material:[t.material],y=x?l.groups:[{materialIndex:0,start:void 0,count:void 0}];for(let t=0,r=y.length;t<r;t++){const r={mode:c,attributes:u};if(this.serializeUserData(l,r),m.length>0&&(r.targets=m),l.index!==null){let s=this.getUID(l.index);(y[t].start!==void 0||y[t].count!==void 0)&&(s+=":"+y[t].start+":"+y[t].count),e.attributes.has(s)?r.indices=e.attributes.get(s):(r.indices=this.processAccessor(l.index,l,y[t].start,y[t].count),e.attributes.set(s,r.indices)),r.indices===null&&delete r.indices}const s=this.processMaterial(L[y[t].materialIndex]);s!==null&&(r.material=s),p.push(r)}w===!0&&l.setIndex(null),h.primitives=p,r.meshes||(r.meshes=[]),this._invokeAll((function(e){e.writeMesh&&e.writeMesh(t,h)}));const C=r.meshes.push(h)-1;return e.meshes.set(i,C),C
/**
   * If a vertex attribute with a
   * [non-standard data type](https://registry.khronos.org/glTF/specs/2.0/glTF-2.0.html#meshes-overview)
   * is used, it is checked whether it is a valid data type according to the
   * [KHR_mesh_quantization](https://github.com/KhronosGroup/glTF/blob/main/extensions/2.0/Khronos/KHR_mesh_quantization/README.md)
   * extension.
   * In this case the extension is automatically added to the list of used extensions.
   *
   * @param {string} attributeName
   * @param {THREE.BufferAttribute} attribute
   */}detectMeshQuantization(t,e){if(this.extensionsUsed[kt])return;let r;switch(e.array.constructor){case Int8Array:r="byte";break;case Uint8Array:r="unsigned byte";break;case Int16Array:r="short";break;case Uint16Array:r="unsigned short";break;default:return}e.normalized&&(r+=" normalized");const s=t.split("_",1)[0];At[s]&&At[s].includes(r)&&(this.extensionsUsed[kt]=!0,this.extensionsRequired[kt]=!0
/**
   * Process camera
   * @param  {THREE.Camera} camera Camera to process
   * @return {Integer}      Index of the processed mesh in the "camera" array
   */)}processCamera(t){const e=this.json;e.cameras||(e.cameras=[]);const r=t.isOrthographicCamera,s={type:r?"orthographic":"perspective"};return r?s.orthographic={xmag:t.right*2,ymag:t.top*2,zfar:t.far<=0?.001:t.far,znear:t.near<0?0:t.near}:s.perspective={aspectRatio:t.aspect,yfov:N.degToRad(t.fov),zfar:t.far<=0?.001:t.far,znear:t.near<0?0:t.near},t.name!==""&&(s.name=t.type),e.cameras.push(s)-1
/**
   * Creates glTF animation entry from AnimationClip object.
   *
   * Status:
   * - Only properties listed in PATH_PROPERTIES may be animated.
   *
   * @param {THREE.AnimationClip} clip
   * @param {THREE.Object3D} root
   * @return {number|null}
   */}processAnimation(t,e){const r=this.json,s=this.nodeMap;r.animations||(r.animations=[]),t=ke.Utils.mergeMorphTargetTracks(t.clone(),e);const i=t.tracks,l=[],c=[];for(let t=0;t<i.length;++t){const r=i[t],h=Z.parseTrackName(r.name);let u=Z.findNode(e,h.nodeName);const p=Ut[h.propertyName];if(h.objectName==="bones"&&(u=u.isSkinnedMesh===!0?u.skeleton.getBoneByName(h.objectIndex):void 0),!u||!p)return console.warn('THREE.GLTFExporter: Could not export animation track "%s".',r.name),null;const m=1;let d=r.values.length/r.times.length;p===Ut.morphTargetInfluences&&(d/=u.morphTargetInfluences.length);let f;r.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline===!0?(f="CUBICSPLINE",d/=3):f=r.getInterpolation()===G?"STEP":"LINEAR",c.push({input:this.processAccessor(new z(r.times,m)),output:this.processAccessor(new z(r.values,d)),interpolation:f}),l.push({sampler:c.length-1,target:{node:s.get(u),path:p}})}return r.animations.push({name:t.name||"clip_"+r.animations.length,samplers:c,channels:l}),r.animations.length-1
/**
   * @param {THREE.Object3D} object
   * @return {number|null}
   */}processSkin(t){const e=this.json,r=this.nodeMap,s=e.nodes[r.get(t)],i=t.skeleton;if(i===void 0)return null;const l=t.skeleton.bones[0];if(l===void 0)return null;const c=[],h=new Float32Array(i.bones.length*16),u=new H;for(let e=0;e<i.bones.length;++e)c.push(r.get(i.bones[e])),u.copy(i.boneInverses[e]),u.multiply(t.bindMatrix).toArray(h,e*16);return e.skins===void 0&&(e.skins=[]),e.skins.push({inverseBindMatrices:this.processAccessor(new z(h,16)),joints:c,skeleton:r.get(l)}),s.skin=e.skins.length-1
/**
   * Process Object3D node
   * @param  {THREE.Object3D} node Object3D to processNode
   * @return {Integer} Index of the node in the nodes list
   */}processNode(t){const e=this.json,r=this.options,s=this.nodeMap;e.nodes||(e.nodes=[]);const i={};if(r.trs){const e=t.quaternion.toArray(),r=t.position.toArray(),s=t.scale.toArray();ae(e,[0,0,0,1])||(i.rotation=e),ae(r,[0,0,0])||(i.translation=r),ae(s,[1,1,1])||(i.scale=s)}else t.matrixAutoUpdate&&t.updateMatrix(),xn(t.matrix)===!1&&(i.matrix=t.matrix.elements);if(t.name!==""&&(i.name=String(t.name)),this.serializeUserData(t,i),t.isMesh||t.isLine||t.isPoints){const e=this.processMesh(t);e!==null&&(i.mesh=e)}else t.isCamera&&(i.camera=this.processCamera(t));if(t.isSkinnedMesh&&this.skins.push(t),t.children.length>0){const e=[];for(let s=0,i=t.children.length;s<i;s++){const i=t.children[s];if(i.visible||r.onlyVisible===!1){const t=this.processNode(i);t!==null&&e.push(t)}}e.length>0&&(i.children=e)}this._invokeAll((function(e){e.writeNode&&e.writeNode(t,i)}));const l=e.nodes.push(i)-1;return s.set(t,l),l
/**
   * Process Scene
   * @param  {Scene} node Scene to process
   */}processScene(t){const e=this.json,r=this.options;e.scenes||(e.scenes=[],e.scene=0);const s={};t.name!==""&&(s.name=t.name),e.scenes.push(s);const i=[];for(let e=0,s=t.children.length;e<s;e++){const s=t.children[e];if(s.visible||r.onlyVisible===!1){const t=this.processNode(s);t!==null&&i.push(t)}}i.length>0&&(s.nodes=i),this.serializeUserData(t,s)
/**
   * Creates a Scene to hold a list of objects and parse it
   * @param  {Array} objects List of objects to process
   */}processObjects(t){const e=new w;e.name="AuxScene";for(let r=0;r<t.length;r++)e.children.push(t[r]);this.processScene(e)}
/**
   * @param {THREE.Object3D|Array<THREE.Object3D>} input
   */processInput(t){const e=this.options;t=t instanceof Array?t:[t],this._invokeAll((function(e){e.beforeParse&&e.beforeParse(t)}));const r=[];for(let e=0;e<t.length;e++)t[e]instanceof w?this.processScene(t[e]):r.push(t[e]);r.length>0&&this.processObjects(r);for(let t=0;t<this.skins.length;++t)this.processSkin(this.skins[t]);for(let r=0;r<e.animations.length;++r)this.processAnimation(e.animations[r],t[0]);this._invokeAll((function(e){e.afterParse&&e.afterParse(t)}))}_invokeAll(t){for(let e=0,r=this.plugins.length;e<r;e++)t(this.plugins[e])}}class Cn{constructor(t){this.writer=t,this.name="KHR_lights_punctual"}writeNode(t,e){if(!t.isLight)return;if(!t.isDirectionalLight&&!t.isPointLight&&!t.isSpotLight){console.warn("THREE.GLTFExporter: Only directional, point, and spot lights are supported.",t);return}const r=this.writer,s=r.json,i=r.extensionsUsed,l={};t.name&&(l.name=t.name),l.color=t.color.toArray(),l.intensity=t.intensity,t.isDirectionalLight?l.type="directional":t.isPointLight?(l.type="point",t.distance>0&&(l.range=t.distance)):t.isSpotLight&&(l.type="spot",t.distance>0&&(l.range=t.distance),l.spot={},l.spot.innerConeAngle=(1-t.penumbra)*t.angle,l.spot.outerConeAngle=t.angle),t.decay!==void 0&&t.decay!==2&&console.warn("THREE.GLTFExporter: Light decay may be lost. glTF is physically-based, and expects light.decay=2."),t.target&&(t.target.parent!==t||t.target.position.x!==0||t.target.position.y!==0||t.target.position.z!==-1)&&console.warn("THREE.GLTFExporter: Light direction may be lost. For best results, make light.target a child of the light with position 0,0,-1."),i[this.name]||(s.extensions=s.extensions||{},s.extensions[this.name]={lights:[]},i[this.name]=!0);const c=s.extensions[this.name].lights;c.push(l),e.extensions=e.extensions||{},e.extensions[this.name]={light:c.length-1}}}class yn{constructor(t){this.writer=t,this.name="KHR_materials_unlit"}writeMaterial(t,e){if(!t.isMeshBasicMaterial)return;const r=this.writer.extensionsUsed;e.extensions=e.extensions||{},e.extensions[this.name]={},r[this.name]=!0,e.pbrMetallicRoughness.metallicFactor=0,e.pbrMetallicRoughness.roughnessFactor=.9}}class Mn{constructor(t){this.writer=t,this.name="KHR_materials_clearcoat"}writeMaterial(t,e){if(!t.isMeshPhysicalMaterial||t.clearcoat===0)return;const r=this.writer,s=r.extensionsUsed,i={};if(i.clearcoatFactor=t.clearcoat,t.clearcoatMap){const e={index:r.processTexture(t.clearcoatMap),texCoord:t.clearcoatMap.channel};r.applyTextureTransform(e,t.clearcoatMap),i.clearcoatTexture=e}if(i.clearcoatRoughnessFactor=t.clearcoatRoughness,t.clearcoatRoughnessMap){const e={index:r.processTexture(t.clearcoatRoughnessMap),texCoord:t.clearcoatRoughnessMap.channel};r.applyTextureTransform(e,t.clearcoatRoughnessMap),i.clearcoatRoughnessTexture=e}if(t.clearcoatNormalMap){const e={index:r.processTexture(t.clearcoatNormalMap),texCoord:t.clearcoatNormalMap.channel};r.applyTextureTransform(e,t.clearcoatNormalMap),i.clearcoatNormalTexture=e}e.extensions=e.extensions||{},e.extensions[this.name]=i,s[this.name]=!0}}class vn{constructor(t){this.writer=t,this.name="KHR_materials_iridescence"}writeMaterial(t,e){if(!t.isMeshPhysicalMaterial||t.iridescence===0)return;const r=this.writer,s=r.extensionsUsed,i={};if(i.iridescenceFactor=t.iridescence,t.iridescenceMap){const e={index:r.processTexture(t.iridescenceMap),texCoord:t.iridescenceMap.channel};r.applyTextureTransform(e,t.iridescenceMap),i.iridescenceTexture=e}if(i.iridescenceIor=t.iridescenceIOR,i.iridescenceThicknessMinimum=t.iridescenceThicknessRange[0],i.iridescenceThicknessMaximum=t.iridescenceThicknessRange[1],t.iridescenceThicknessMap){const e={index:r.processTexture(t.iridescenceThicknessMap),texCoord:t.iridescenceThicknessMap.channel};r.applyTextureTransform(e,t.iridescenceThicknessMap),i.iridescenceThicknessTexture=e}e.extensions=e.extensions||{},e.extensions[this.name]=i,s[this.name]=!0}}class Tn{constructor(t){this.writer=t,this.name="KHR_materials_transmission"}writeMaterial(t,e){if(!t.isMeshPhysicalMaterial||t.transmission===0)return;const r=this.writer,s=r.extensionsUsed,i={};if(i.transmissionFactor=t.transmission,t.transmissionMap){const e={index:r.processTexture(t.transmissionMap),texCoord:t.transmissionMap.channel};r.applyTextureTransform(e,t.transmissionMap),i.transmissionTexture=e}e.extensions=e.extensions||{},e.extensions[this.name]=i,s[this.name]=!0}}class bn{constructor(t){this.writer=t,this.name="KHR_materials_volume"}writeMaterial(t,e){if(!t.isMeshPhysicalMaterial||t.transmission===0)return;const r=this.writer,s=r.extensionsUsed,i={};if(i.thicknessFactor=t.thickness,t.thicknessMap){const e={index:r.processTexture(t.thicknessMap),texCoord:t.thicknessMap.channel};r.applyTextureTransform(e,t.thicknessMap),i.thicknessTexture=e}i.attenuationDistance=t.attenuationDistance,i.attenuationColor=t.attenuationColor.toArray(),e.extensions=e.extensions||{},e.extensions[this.name]=i,s[this.name]=!0}}class En{constructor(t){this.writer=t,this.name="KHR_materials_ior"}writeMaterial(t,e){if(!t.isMeshPhysicalMaterial||t.ior===1.5)return;const r=this.writer.extensionsUsed,s={};s.ior=t.ior,e.extensions=e.extensions||{},e.extensions[this.name]=s,r[this.name]=!0}}class Sn{constructor(t){this.writer=t,this.name="KHR_materials_specular"}writeMaterial(t,e){if(!t.isMeshPhysicalMaterial||t.specularIntensity===1&&t.specularColor.equals(Bt)&&!t.specularIntensityMap&&!t.specularColorMap)return;const r=this.writer,s=r.extensionsUsed,i={};if(t.specularIntensityMap){const e={index:r.processTexture(t.specularIntensityMap),texCoord:t.specularIntensityMap.channel};r.applyTextureTransform(e,t.specularIntensityMap),i.specularTexture=e}if(t.specularColorMap){const e={index:r.processTexture(t.specularColorMap),texCoord:t.specularColorMap.channel};r.applyTextureTransform(e,t.specularColorMap),i.specularColorTexture=e}i.specularFactor=t.specularIntensity,i.specularColorFactor=t.specularColor.toArray(),e.extensions=e.extensions||{},e.extensions[this.name]=i,s[this.name]=!0}}class In{constructor(t){this.writer=t,this.name="KHR_materials_sheen"}writeMaterial(t,e){if(!t.isMeshPhysicalMaterial||t.sheen==0)return;const r=this.writer,s=r.extensionsUsed,i={};if(t.sheenRoughnessMap){const e={index:r.processTexture(t.sheenRoughnessMap),texCoord:t.sheenRoughnessMap.channel};r.applyTextureTransform(e,t.sheenRoughnessMap),i.sheenRoughnessTexture=e}if(t.sheenColorMap){const e={index:r.processTexture(t.sheenColorMap),texCoord:t.sheenColorMap.channel};r.applyTextureTransform(e,t.sheenColorMap),i.sheenColorTexture=e}i.sheenRoughnessFactor=t.sheenRoughness,i.sheenColorFactor=t.sheenColor.toArray(),e.extensions=e.extensions||{},e.extensions[this.name]=i,s[this.name]=!0}}class An{constructor(t){this.writer=t,this.name="KHR_materials_anisotropy"}writeMaterial(t,e){if(!t.isMeshPhysicalMaterial||t.anisotropy==0)return;const r=this.writer,s=r.extensionsUsed,i={};if(t.anisotropyMap){const e={index:r.processTexture(t.anisotropyMap)};r.applyTextureTransform(e,t.anisotropyMap),i.anisotropyTexture=e}i.anisotropyStrength=t.anisotropy,i.anisotropyRotation=t.anisotropyRotation,e.extensions=e.extensions||{},e.extensions[this.name]=i,s[this.name]=!0}}class _n{constructor(t){this.writer=t,this.name="KHR_materials_emissive_strength"}writeMaterial(t,e){if(!t.isMeshStandardMaterial||t.emissiveIntensity===1)return;const r=this.writer.extensionsUsed,s={};s.emissiveStrength=t.emissiveIntensity,e.extensions=e.extensions||{},e.extensions[this.name]=s,r[this.name]=!0}}class Rn{constructor(t){this.writer=t,this.name="EXT_materials_bump"}writeMaterial(t,e){if(!t.isMeshStandardMaterial||t.bumpScale===1&&!t.bumpMap)return;const r=this.writer,s=r.extensionsUsed,i={};if(t.bumpMap){const e={index:r.processTexture(t.bumpMap),texCoord:t.bumpMap.channel};r.applyTextureTransform(e,t.bumpMap),i.bumpTexture=e}i.bumpFactor=t.bumpScale,e.extensions=e.extensions||{},e.extensions[this.name]=i,s[this.name]=!0}}class Dn{constructor(t){this.writer=t,this.name="EXT_mesh_gpu_instancing"}writeNode(t,e){if(!t.isInstancedMesh)return;const r=this.writer,s=t,i=new Float32Array(s.count*3),l=new Float32Array(s.count*4),c=new Float32Array(s.count*3),h=new H,u=new U,p=new V,m=new U;for(let t=0;t<s.count;t++)s.getMatrixAt(t,h),h.decompose(u,p,m),u.toArray(i,t*3),p.toArray(l,t*4),m.toArray(c,t*3);const d={TRANSLATION:r.processAccessor(new z(i,3)),ROTATION:r.processAccessor(new z(l,4)),SCALE:r.processAccessor(new z(c,3))};s.instanceColor&&(d._COLOR_0=r.processAccessor(s.instanceColor)),e.extensions=e.extensions||{},e.extensions[this.name]={attributes:d},r.extensionsUsed[this.name]=!0,r.extensionsRequired[this.name]=!0}}ke.Utils={insertKeyframe:function(t,e){const r=t.getValueSize(),s=new t.TimeBufferType(t.times.length+1),i=new t.ValueBufferType(t.values.length+r),l=t.createInterpolant(new t.ValueBufferType(r));let c;if(t.times.length===0){s[0]=e;for(let t=0;t<r;t++)i[t]=0;c=0}else if(e<t.times[0]){if(Math.abs(t.times[0]-e)<.001)return 0;s[0]=e,s.set(t.times,1),i.set(l.evaluate(e),0),i.set(t.values,r),c=0}else if(e>t.times[t.times.length-1]){if(Math.abs(t.times[t.times.length-1]-e)<.001)return t.times.length-1;s[s.length-1]=e,s.set(t.times,0),i.set(t.values,0),i.set(l.evaluate(e),t.values.length),c=s.length-1}else for(let h=0;h<t.times.length;h++){if(Math.abs(t.times[h]-e)<.001)return h;if(t.times[h]<e&&t.times[h+1]>e){s.set(t.times.slice(0,h+1),0),s[h+1]=e,s.set(t.times.slice(h+1),h+2),i.set(t.values.slice(0,(h+1)*r),0),i.set(l.evaluate(e),(h+1)*r),i.set(t.values.slice((h+1)*r),(h+2)*r),c=h+1;break}}return t.times=s,t.values=i,c},mergeMorphTargetTracks:function(t,e){const r=[],s={},i=t.tracks;for(let t=0;t<i.length;++t){let l=i[t];const c=Z.parseTrackName(l.name),h=Z.findNode(e,c.nodeName);if(c.propertyName!=="morphTargetInfluences"||c.propertyIndex===void 0){r.push(l);continue}if(l.createInterpolant!==l.InterpolantFactoryMethodDiscrete&&l.createInterpolant!==l.InterpolantFactoryMethodLinear){if(l.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline)throw new Error("THREE.GLTFExporter: Cannot merge tracks with glTF CUBICSPLINE interpolation.");console.warn("THREE.GLTFExporter: Morph target interpolation mode not yet supported. Using LINEAR instead."),l=l.clone(),l.setInterpolation(j)}const u=h.morphTargetInfluences.length,p=h.morphTargetDictionary[c.propertyIndex];if(p===void 0)throw new Error("THREE.GLTFExporter: Morph target name not found: "+c.propertyIndex);let m;if(s[h.uuid]===void 0){m=l.clone();const t=new m.ValueBufferType(u*m.times.length);for(let e=0;e<m.times.length;e++)t[e*u+p]=m.values[e];m.name=(c.nodeName||"")+".morphTargetInfluences",m.values=t,s[h.uuid]=m,r.push(m);continue}const d=l.createInterpolant(new l.ValueBufferType(1));m=s[h.uuid];for(let t=0;t<m.times.length;t++)m.values[t*u+p]=d.evaluate(m.times[t]);for(let t=0;t<l.times.length;t++){const e=this.insertKeyframe(m,l.times[t]);m.values[e*u+p]=l.values[t]}}return t.tracks=r,t}};var Gt=Uint8Array,Ht=Uint16Array,Vt=Int32Array,jt=new Gt([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),Wt=new Gt([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),Yt=new Gt([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),dt=function(t,e){for(var r=new Ht(31),s=0;s<31;++s)r[s]=e+=1<<t[s-1];var i=new Vt(r[30]);for(s=1;s<30;++s)for(var l=r[s];l<r[s+1];++l)i[l]=l-r[s]<<5|s;return{b:r,r:i}},Xt=dt(jt,2),Kt=Xt.b,qt=Xt.r;Kt[28]=258,qt[258]=28;var Jt=dt(Wt,0),Qt=Jt.r,te=new Ht(32768);for(var ee=0;ee<32768;++ee){var re=(ee&43690)>>1|(ee&21845)<<1;re=(re&52428)>>2|(re&13107)<<2,re=(re&61680)>>4|(re&3855)<<4,te[ee]=((re&65280)>>8|(re&255)<<8)>>1}var le=function(t,e,r){for(var s=t.length,i=0,l=new Ht(e);i<s;++i)t[i]&&++l[t[i]-1];var c=new Ht(e);for(i=1;i<e;++i)c[i]=c[i-1]+l[i-1]<<1;var h;if(r){h=new Ht(1<<e);var u=15-e;for(i=0;i<s;++i)if(t[i])for(var p=i<<4|t[i],m=e-t[i],d=c[t[i]-1]++<<m,f=d|(1<<m)-1;d<=f;++d)h[te[d]>>u]=p}else for(h=new Ht(s),i=0;i<s;++i)t[i]&&(h[i]=te[c[t[i]-1]++]>>15-t[i]);return h},se=new Gt(288);for(ee=0;ee<144;++ee)se[ee]=8;for(ee=144;ee<256;++ee)se[ee]=9;for(ee=256;ee<280;++ee)se[ee]=7;for(ee=280;ee<288;++ee)se[ee]=8;var ce=new Gt(32);for(ee=0;ee<32;++ee)ce[ee]=5;var ue=le(se,9,0),me=le(ce,5,0),mt=function(t){return(t+7)/8|0},xt=function(t,e,r){return(e==null||e<0)&&(e=0),(r==null||r>t.length)&&(r=t.length),new Gt(t.subarray(e,r))},de=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],we=function(t,e,r){var s=new Error(e||de[t]);if(s.code=t,Error.captureStackTrace&&Error.captureStackTrace(s,we),!r)throw s;return s},W=function(t,e,r){r<<=e&7;var s=e/8|0;t[s]|=r,t[s+1]|=r>>8},ie=function(t,e,r){r<<=e&7;var s=e/8|0;t[s]|=r,t[s+1]|=r>>8,t[s+2]|=r>>16},Se=function(t,e){for(var r=[],s=0;s<t.length;++s)t[s]&&r.push({s:s,f:t[s]});var i=r.length,l=r.slice();if(!i)return{t:Le,l:0};if(i==1){var c=new Gt(r[0].s+1);return c[r[0].s]=1,{t:c,l:1}}r.sort((function(t,e){return t.f-e.f})),r.push({s:-1,f:25001});var h=r[0],u=r[1],p=0,m=1,d=2;for(r[0]={s:-1,f:h.f+u.f,l:h,r:u};m!=i-1;)h=r[r[p].f<r[d].f?p++:d++],u=r[p!=m&&r[p].f<r[d].f?p++:d++],r[m++]={s:-1,f:h.f+u.f,l:h,r:u};var f=l[0].s;for(s=1;s<i;++s)l[s].s>f&&(f=l[s].s);var g=new Ht(f+1),x=De(r[m-1],g,0);if(x>e){s=0;var w=0,L=x-e,y=1<<L;for(l.sort((function(t,e){return g[e.s]-g[t.s]||t.f-e.f}));s<i;++s){var C=l[s].s;if(!(g[C]>e))break;w+=y-(1<<x-g[C]),g[C]=e}for(w>>=L;w>0;){var M=l[s].s;g[M]<e?w-=1<<e-g[M]++-1:++s}for(;s>=0&&w;--s){var T=l[s].s;g[T]==e&&(--g[T],++w)}x=e}return{t:new Gt(g),l:x}},De=function(t,e,r){return t.s==-1?Math.max(De(t.l,e,r+1),De(t.r,e,r+1)):e[t.s]=r},Qe=function(t){for(var e=t.length;e&&!t[--e];);for(var r=new Ht(++e),s=0,i=t[0],l=1,o=function(t){r[s++]=t},c=1;c<=e;++c)if(t[c]==i&&c!=e)++l;else{if(!i&&l>2){for(;l>138;l-=138)o(32754);l>2&&(o(l>10?l-11<<5|28690:l-3<<5|12305),l=0)}else if(l>3){for(o(i),--l;l>6;l-=6)o(8304);l>2&&(o(l-3<<5|8208),l=0)}for(;l--;)o(i);l=1,i=t[c]}return{c:r.subarray(0,s),n:e}},oe=function(t,e){for(var r=0,s=0;s<e.length;++s)r+=t[s]*e[s];return r},wt=function(t,e,r){var s=r.length,i=mt(e+2);t[i]=s&255,t[i+1]=s>>8,t[i+2]=t[i]^255,t[i+3]=t[i+1]^255;for(var l=0;l<s;++l)t[i+l+4]=r[l];return(i+4+s)*8},et=function(t,e,r,s,i,l,c,h,u,p,m){W(e,m++,r),++i[256];for(var d=Se(i,15),f=d.t,g=d.l,x=Se(l,15),w=x.t,L=x.l,y=Qe(f),C=y.c,M=y.n,T=Qe(w),b=T.c,v=T.n,S=new Ht(19),I=0;I<C.length;++I)++S[C[I]&31];for(I=0;I<b.length;++I)++S[b[I]&31];for(var _=Se(S,7),R=_.t,D=_.l,N=19;N>4&&!R[Yt[N-1]];--N);var U=p+5<<3,B=oe(i,se)+oe(l,ce)+c,F=oe(i,f)+oe(l,w)+c+14+3*N+oe(S,R)+2*S[16]+3*S[17]+7*S[18];if(u>=0&&U<=B&&U<=F)return wt(e,m,t.subarray(u,u+p));var O,P,$,z;if(W(e,m,1+(F<B)),m+=2,F<B){O=le(f,g,0),P=f,$=le(w,L,0),z=w;var Z=le(R,D,0);W(e,m,M-257),W(e,m+5,v-1),W(e,m+10,N-4),m+=14;for(I=0;I<N;++I)W(e,m+3*I,R[Yt[I]]);m+=3*N;for(var G=[C,b],H=0;H<2;++H){var V=G[H];for(I=0;I<V.length;++I){var j=V[I]&31;W(e,m,Z[j]),m+=R[j],j>15&&(W(e,m,V[I]>>5&127),m+=V[I]>>12)}}}else O=ue,P=se,$=me,z=ce;for(I=0;I<h;++I){var Y=s[I];if(Y>255){j=Y>>18&31;ie(e,m,O[j+257]),m+=P[j+257],j>7&&(W(e,m,Y>>23&31),m+=jt[j]);var X=Y&31;ie(e,m,$[X]),m+=z[X],X>3&&(ie(e,m,Y>>5&8191),m+=Wt[X])}else ie(e,m,O[Y]),m+=P[Y]}return ie(e,m,O[256]),m+P[256]},ge=new Vt([65540,131080,131088,131104,262176,1048704,1048832,2114560,2117632]),Le=new Gt(0),On=function(t,e,r,s,i,l){var c=l.z||t.length,h=new Gt(s+c+5*(1+Math.ceil(c/7e3))+i),u=h.subarray(s,h.length-i),p=l.l,m=(l.r||0)&7;if(e){m&&(u[0]=l.r>>3);for(var d=ge[e-1],f=d>>13,g=d&8191,x=(1<<r)-1,w=l.p||new Ht(32768),L=l.h||new Ht(x+1),y=Math.ceil(r/3),C=2*y,A=function(e){return(t[e]^t[e+1]<<y^t[e+2]<<C)&x},M=new Vt(25e3),T=new Ht(288),b=new Ht(32),v=0,S=0,I=l.i||0,_=0,R=l.w||0,D=0;I+2<c;++I){var N=A(I),U=I&32767,B=L[N];if(w[U]=B,L[N]=U,R<=I){var F=c-I;if((v>7e3||_>24576)&&(F>423||!p)){m=et(t,u,0,M,T,b,S,_,D,I-D,m),_=v=S=0,D=I;for(var O=0;O<286;++O)T[O]=0;for(O=0;O<30;++O)b[O]=0}var P=2,$=0,z=g,Z=U-B&32767;if(F>2&&N==A(I-Z))for(var G=Math.min(f,F)-1,H=Math.min(32767,I),V=Math.min(258,F);Z<=H&&--z&&U!=B;){if(t[I+P]==t[I+P-Z]){for(var j=0;j<V&&t[I+j]==t[I+j-Z];++j);if(j>P){if(P=j,$=Z,j>G)break;var Y=Math.min(Z,j-2),X=0;for(O=0;O<Y;++O){var K=I-Z+O&32767,q=w[K],J=K-q&32767;J>X&&(X=J,B=K)}}}U=B,B=w[U],Z+=U-B&32767}if($){M[_++]=268435456|qt[P]<<18|Qt[$];var Q=qt[P]&31,tt=Qt[$]&31;S+=jt[Q]+Wt[tt],++T[257+Q],++b[tt],R=I+P,++v}else M[_++]=t[I],++T[t[I]]}}for(I=Math.max(I,R);I<c;++I)M[_++]=t[I],++T[t[I]];m=et(t,u,p,M,T,b,S,_,D,I-D,m),p||(l.r=m&7|u[m/8|0]<<3,m-=7,l.h=L,l.p=w,l.i=I,l.w=R)}else{for(I=l.w||0;I<c+p;I+=65535){var it=I+65535;it>=c&&(u[m/8|0]=p,it=c),m=wt(u,m+1,t.subarray(I,it))}l.i=c}return xt(h,0,s+mt(m)+i)},ye=function(){for(var t=new Int32Array(256),e=0;e<256;++e){for(var r=e,s=9;--s;)r=(r&1&&-306674912)^r>>>1;t[e]=r}return t}(),Gn=function(){var t=-1;return{p:function(e){for(var r=t,s=0;s<e.length;++s)r=ye[r&255^e[s]]^r>>>8;t=r},d:function(){return~t}}},$n=function(t,e,r,s,i){if(!i&&(i={l:1},e.dictionary)){var l=e.dictionary.subarray(-32768),c=new Gt(l.length+t.length);c.set(l),c.set(t,l.length),t=c,i.w=l.length}return On(t,e.level==null?6:e.level,e.mem==null?i.l?Math.ceil(Math.max(8,Math.min(13,Math.log(t.length)))*1.5):20:12+e.mem,r,s,i)},Ct=function(t,e){var r={};for(var s in t)r[s]=t[s];for(var s in e)r[s]=e[s];return r},k=function(t,e,r){for(;r;++e)t[e]=r,r>>>=8};function Zn(t,e){return $n(t,e||{},0,0)}var yt=function(t,e,r,s){for(var i in t){var l=t[i],c=e+i,h=s;Array.isArray(l)&&(h=Ct(s,l[1]),l=l[0]),l instanceof Gt?r[c]=[l,h]:(r[c+="/"]=[new Gt(0),h],yt(l,c,r,s))}},Ce=typeof TextEncoder<"u"&&new TextEncoder,Me=typeof TextDecoder<"u"&&new TextDecoder;try{Me.decode(Le,{stream:!0}),1}catch{}function xe(t,e){if(e){for(var r=new Gt(t.length),s=0;s<t.length;++s)r[s]=t.charCodeAt(s);return r}if(Ce)return Ce.encode(t);var i=t.length,l=new Gt(t.length+(t.length>>1)),c=0,a=function(t){l[c++]=t};for(s=0;s<i;++s){if(c+5>l.length){var h=new Gt(c+8+(i-s<<1));h.set(l),l=h}var u=t.charCodeAt(s);u<128||e?a(u):u<2048?(a(192|u>>6),a(128|u&63)):u>55295&&u<57344?(u=65536+(u&1047552)|t.charCodeAt(++s)&1023,a(240|u>>18),a(128|u>>12&63),a(128|u>>6&63),a(128|u&63)):(a(224|u>>12),a(128|u>>6&63),a(128|u&63))}return xt(l,0,c)}var Ne=function(t){var e=0;if(t)for(var r in t){var s=t[r].length;s>65535&&we(9),e+=s+4}return e},nt=function(t,e,r,s,i,l,c,h){var u=s.length,p=r.extra,m=h&&h.length,d=Ne(p);k(t,e,c!=null?33639248:67324752),e+=4,c!=null&&(t[e++]=20,t[e++]=r.os),t[e]=20,e+=2,t[e++]=r.flag<<1|(l<0&&8),t[e++]=i&&8,t[e++]=r.compression&255,t[e++]=r.compression>>8;var f=new Date(r.mtime==null?Date.now():r.mtime),g=f.getFullYear()-1980;if((g<0||g>119)&&we(10),k(t,e,g<<25|f.getMonth()+1<<21|f.getDate()<<16|f.getHours()<<11|f.getMinutes()<<5|f.getSeconds()>>1),e+=4,l!=-1&&(k(t,e,r.crc),k(t,e+4,l<0?-l-2:l),k(t,e+8,r.size)),k(t,e+12,u),k(t,e+14,d),e+=16,c!=null&&(k(t,e,m),k(t,e+6,r.attrs),k(t,e+10,c),e+=14),t.set(s,e),e+=u,d)for(var x in p){var w=p[x],L=w.length;k(t,e,+x),k(t,e+2,L),t.set(w,e+4),e+=4+L}return m&&(t.set(h,e),e+=m),e},jn=function(t,e,r,s,i){k(t,e,101010256),k(t,e+8,r),k(t,e+10,r),k(t,e+12,s),k(t,e+16,i)};function Wn(t,e){e||(e={});var r={},s=[];yt(t,"",r,e);var i=0,l=0;for(var c in r){var h=r[c],u=h[0],p=h[1],m=p.level==0?0:8,d=xe(c),f=d.length,g=p.comment,x=g&&xe(g),w=x&&x.length,L=Ne(p.extra);f>65535&&we(11);var y=m?Zn(u,p):u,C=y.length,M=Gn();M.p(u),s.push(Ct(p,{size:u.length,crc:M.d(),c:y,f:d,m:x,u:f!=c.length||x&&g.length!=w,o:i,compression:m})),i+=30+f+L+C,l+=76+2*(f+L)+(w||0)+C}for(var T=new Gt(l+22),b=i,v=l-i,S=0;S<s.length;++S){d=s[S];nt(T,d.o,d,d.f,d.u,d.c.length);var I=30+d.f.length+Ne(d.extra);T.set(d.c,d.o+I),nt(T,i,d,d.f,d.u,d.c.length,d.o,d.m),i+=16+I+(d.m?d.m.length:0)}return jn(T,i,s.length,v,b),T}class Yn{async parse(t,e={}){e=Object.assign({ar:{anchoring:{type:"plane"},planeAnchoring:{alignment:"horizontal"}},quickLookCompatible:!1,maxTextureSize:1024},e);const r={},s="model.usda";r[s]=null;let i=Mt();i+=Kn(e);const l={},c={};t.traverseVisible((t=>{if(t.isMesh){const e=t.geometry,s=t.material;if(s.isMeshStandardMaterial){const c="geometries/Geometry_"+e.id+".usda";if(!(c in r)){const t=es(e);r[c]=Jn(t)}s.uuid in l||(l[s.uuid]=s),i+=Qn(t,e,s)}else console.warn("THREE.USDZExporter: Unsupported material type (USDZ only supports MeshStandardMaterial)",t)}else t.isCamera&&(i+=cs(t))})),i+=qn(),i+=os(l,c,e.quickLookCompatible),r[s]=xe(i),i=null;for(const t in c){let s=c[t];s.isCompressedTexture===!0&&(s=pe(s));const i=Xn(s.image,s.flipY,e.maxTextureSize),l=await new Promise((t=>i.toBlob(t,"image/png",1)));r[`textures/Texture_${t}.png`]=new Uint8Array(await l.arrayBuffer())}let h=0;for(const t in r){const e=r[t],s=34+t.length;h+=s;const i=h&63;if(i!==4){const s=64-i,l=new Uint8Array(s);r[t]=[e,{extra:{12345:l}}]}h=e.length}return Wn(r,{level:0})}}function Xn(t,e,r){if(typeof HTMLImageElement<"u"&&t instanceof HTMLImageElement||typeof HTMLCanvasElement<"u"&&t instanceof HTMLCanvasElement||typeof OffscreenCanvas<"u"&&t instanceof OffscreenCanvas||typeof ImageBitmap<"u"&&t instanceof ImageBitmap){const s=r/Math.max(t.width,t.height),i=document.createElement("canvas");i.width=t.width*Math.min(1,s),i.height=t.height*Math.min(1,s);const l=i.getContext("2d");return e===!0&&(l.translate(0,i.height),l.scale(1,-1)),l.drawImage(t,0,0,i.width,i.height),i}throw new Error("THREE.USDZExporter: No valid image data found. Unable to process texture.")}const Te=7;function Mt(){return'#usda 1.0\n(\n\tcustomLayerData = {\n\t\tstring creator = "Three.js USDZExporter"\n\t}\n\tdefaultPrim = "Root"\n\tmetersPerUnit = 1\n\tupAxis = "Y"\n)\n\n'}function Kn(t){return`def Xform "Root"\n{\n\tdef Scope "Scenes" (\n\t\tkind = "sceneLibrary"\n\t)\n\t{\n\t\tdef Xform "Scene" (\n\t\t\tcustomData = {\n\t\t\t\tbool preliminary_collidesWithEnvironment = 0\n\t\t\t\tstring sceneName = "Scene"\n\t\t\t}\n\t\t\tsceneName = "Scene"\n\t\t)\n\t\t{\n\t\ttoken preliminary:anchoring:type = "${t.ar.anchoring.type}"\n\t\ttoken preliminary:planeAnchoring:alignment = "${t.ar.planeAnchoring.alignment}"\n\n`}function qn(){return"\n\t\t}\n\t}\n}\n\n"}function Jn(t){let e=Mt();return e+=t,xe(e)}function Qn(t,e,r){const s="Object_"+t.id,i=vt(t.matrixWorld);return t.matrixWorld.determinant()<0&&console.warn("THREE.USDZExporter: USDZ does not support negative scales",t),`def Xform "${s}" (\n\tprepend references = @./geometries/Geometry_${e.id}.usda@</Geometry>\n\tprepend apiSchemas = ["MaterialBindingAPI"]\n)\n{\n\tmatrix4d xformOp:transform = ${i}\n\tuniform token[] xformOpOrder = ["xformOp:transform"]\n\n\trel material:binding = </Materials/Material_${r.id}>\n}\n\n`}function vt(t){const e=t.elements;return`( ${he(e,0)}, ${he(e,4)}, ${he(e,8)}, ${he(e,12)} )`}function he(t,e){return`(${t[e+0]}, ${t[e+1]}, ${t[e+2]}, ${t[e+3]})`}function es(t){return`\ndef "Geometry"\n{\n${ts(t)}\n}\n`}function ts(t){const e="Geometry",r=t.attributes,s=r.position.count;return`\n\tdef Mesh "${e}"\n\t{\n\t\tint[] faceVertexCounts = [${ns(t)}]\n\t\tint[] faceVertexIndices = [${ss(t)}]\n\t\tnormal3f[] normals = [${Ue(r.normal,s)}] (\n\t\t\tinterpolation = "vertex"\n\t\t)\n\t\tpoint3f[] points = [${Ue(r.position,s)}]\n${is(r)}\n\t\tuniform token subdivisionScheme = "none"\n\t}\n`}function ns(t){const e=t.index!==null?t.index.count:t.attributes.position.count;return Array(e/3).fill(3).join(", ")}function ss(t){const e=t.index,r=[];if(e!==null)for(let t=0;t<e.count;t++)r.push(e.getX(t));else{const e=t.attributes.position.count;for(let t=0;t<e;t++)r.push(t)}return r.join(", ")}function Ue(t,e){if(t===void 0)return console.warn("USDZExporter: Normals missing."),Array(e).fill("(0, 0, 0)").join(", ");const r=[];for(let e=0;e<t.count;e++){const s=t.getX(e),i=t.getY(e),l=t.getZ(e);r.push(`(${s.toPrecision(Te)}, ${i.toPrecision(Te)}, ${l.toPrecision(Te)})`)}return r.join(", ")}function rs(t){const e=[];for(let r=0;r<t.count;r++){const s=t.getX(r),i=t.getY(r);e.push(`(${s.toPrecision(Te)}, ${1-i.toPrecision(Te)})`)}return e.join(", ")}function is(t){let e="";for(let r=0;r<4;r++){const s=r>0?r:"",i=t["uv"+s];i!==void 0&&(e+=`\n\t\ttexCoord2f[] primvars:st${s} = [${rs(i)}] (\n\t\t\tinterpolation = "vertex"\n\t\t)`)}const r=t.color;if(r!==void 0){const t=r.count;e+=`\n\tcolor3f[] primvars:displayColor = [${Ue(r,t)}] (\n\t\tinterpolation = "vertex"\n\t\t)`}return e}function os(t,e,r=!1){const s=[];for(const i in t){const l=t[i];s.push(as(l,e,r))}return`def "Materials"\n{\n${s.join("")}\n}\n\n`}function as(t,e,r=!1){const s="\t\t\t",i=[],l=[];function o(s,i,l){const c=s.source.id+"_"+s.flipY;e[c]=s;const h=s.channel>0?"st"+s.channel:"st",u={1e3:"repeat",1001:"clamp",1002:"mirror"},p=s.repeat.clone(),m=s.offset.clone(),d=s.rotation,f=Math.sin(d),g=Math.cos(d);return m.y=1-m.y-p.y,r?(m.x=m.x/p.x,m.y=m.y/p.y,m.x+=f/p.x,m.y+=g-1):(m.x+=f*p.x,m.y+=(1-g)*p.y),`\n\t\tdef Shader "PrimvarReader_${i}"\n\t\t{\n\t\t\tuniform token info:id = "UsdPrimvarReader_float2"\n\t\t\tfloat2 inputs:fallback = (0.0, 0.0)\n\t\t\ttoken inputs:varname = "${h}"\n\t\t\tfloat2 outputs:result\n\t\t}\n\n\t\tdef Shader "Transform2d_${i}"\n\t\t{\n\t\t\tuniform token info:id = "UsdTransform2d"\n\t\t\ttoken inputs:in.connect = </Materials/Material_${t.id}/PrimvarReader_${i}.outputs:result>\n\t\t\tfloat inputs:rotation = ${(d*(180/Math.PI)).toFixed(Te)}\n\t\t\tfloat2 inputs:scale = ${rt(p)}\n\t\t\tfloat2 inputs:translation = ${rt(m)}\n\t\t\tfloat2 outputs:result\n\t\t}\n\n\t\tdef Shader "Texture_${s.id}_${i}"\n\t\t{\n\t\t\tuniform token info:id = "UsdUVTexture"\n\t\t\tasset inputs:file = @textures/Texture_${c}.png@\n\t\t\tfloat2 inputs:st.connect = </Materials/Material_${t.id}/Transform2d_${i}.outputs:result>\n\t\t\t${l!==void 0?"float4 inputs:scale = "+ls(l):""}\n\t\t\ttoken inputs:sourceColorSpace = "${s.colorSpace===O?"raw":"sRGB"}"\n\t\t\ttoken inputs:wrapS = "${u[s.wrapS]}"\n\t\t\ttoken inputs:wrapT = "${u[s.wrapT]}"\n\t\t\tfloat outputs:r\n\t\t\tfloat outputs:g\n\t\t\tfloat outputs:b\n\t\t\tfloat3 outputs:rgb\n\t\t\t${t.transparent||t.alphaTest>0?"float outputs:a":""}\n\t\t}`}return t.side===$&&console.warn("THREE.USDZExporter: USDZ does not support double sided materials",t),t.map!==null?(i.push(`${s}color3f inputs:diffuseColor.connect = </Materials/Material_${t.id}/Texture_${t.map.id}_diffuse.outputs:rgb>`),t.transparent?i.push(`${s}float inputs:opacity.connect = </Materials/Material_${t.id}/Texture_${t.map.id}_diffuse.outputs:a>`):t.alphaTest>0&&(i.push(`${s}float inputs:opacity.connect = </Materials/Material_${t.id}/Texture_${t.map.id}_diffuse.outputs:a>`),i.push(`${s}float inputs:opacityThreshold = ${t.alphaTest}`)),l.push(o(t.map,"diffuse",t.color))):i.push(`${s}color3f inputs:diffuseColor = ${st(t.color)}`),t.emissiveMap!==null?(i.push(`${s}color3f inputs:emissiveColor.connect = </Materials/Material_${t.id}/Texture_${t.emissiveMap.id}_emissive.outputs:rgb>`),l.push(o(t.emissiveMap,"emissive"))):t.emissive.getHex()>0&&i.push(`${s}color3f inputs:emissiveColor = ${st(t.emissive)}`),t.normalMap!==null&&(i.push(`${s}normal3f inputs:normal.connect = </Materials/Material_${t.id}/Texture_${t.normalMap.id}_normal.outputs:rgb>`),l.push(o(t.normalMap,"normal"))),t.aoMap!==null&&(i.push(`${s}float inputs:occlusion.connect = </Materials/Material_${t.id}/Texture_${t.aoMap.id}_occlusion.outputs:r>`),l.push(o(t.aoMap,"occlusion"))),t.roughnessMap!==null&&t.roughness===1?(i.push(`${s}float inputs:roughness.connect = </Materials/Material_${t.id}/Texture_${t.roughnessMap.id}_roughness.outputs:g>`),l.push(o(t.roughnessMap,"roughness"))):i.push(`${s}float inputs:roughness = ${t.roughness}`),t.metalnessMap!==null&&t.metalness===1?(i.push(`${s}float inputs:metallic.connect = </Materials/Material_${t.id}/Texture_${t.metalnessMap.id}_metallic.outputs:b>`),l.push(o(t.metalnessMap,"metallic"))):i.push(`${s}float inputs:metallic = ${t.metalness}`),t.alphaMap!==null?(i.push(`${s}float inputs:opacity.connect = </Materials/Material_${t.id}/Texture_${t.alphaMap.id}_opacity.outputs:r>`),i.push(`${s}float inputs:opacityThreshold = 0.0001`),l.push(o(t.alphaMap,"opacity"))):i.push(`${s}float inputs:opacity = ${t.opacity}`),t.isMeshPhysicalMaterial&&(i.push(`${s}float inputs:clearcoat = ${t.clearcoat}`),i.push(`${s}float inputs:clearcoatRoughness = ${t.clearcoatRoughness}`),i.push(`${s}float inputs:ior = ${t.ior}`)),`\n\tdef Material "Material_${t.id}"\n\t{\n\t\tdef Shader "PreviewSurface"\n\t\t{\n\t\t\tuniform token info:id = "UsdPreviewSurface"\n${i.join("\n")}\n\t\t\tint inputs:useSpecularWorkflow = 0\n\t\t\ttoken outputs:surface\n\t\t}\n\n\t\ttoken outputs:surface.connect = </Materials/Material_${t.id}/PreviewSurface.outputs:surface>\n\n${l.join("\n")}\n\n\t}\n`}function st(t){return`(${t.r}, ${t.g}, ${t.b})`}function ls(t){return`(${t.r}, ${t.g}, ${t.b}, 1.0)`}function rt(t){return`(${t.x}, ${t.y})`}function cs(t){const e=t.name?t.name:"Camera_"+t.id,r=vt(t.matrixWorld);return t.matrixWorld.determinant()<0&&console.warn("THREE.USDZExporter: USDZ does not support negative scales",t),t.isOrthographicCamera?`def Camera "${e}"\n\t\t{\n\t\t\tmatrix4d xformOp:transform = ${r}\n\t\t\tuniform token[] xformOpOrder = ["xformOp:transform"]\n\n\t\t\tfloat2 clippingRange = (${t.near.toPrecision(Te)}, ${t.far.toPrecision(Te)})\n\t\t\tfloat horizontalAperture = ${((Math.abs(t.left)+Math.abs(t.right))*10).toPrecision(Te)}\n\t\t\tfloat verticalAperture = ${((Math.abs(t.top)+Math.abs(t.bottom))*10).toPrecision(Te)}\n\t\t\ttoken projection = "orthographic"\n\t\t}\n\t\n\t`:`def Camera "${e}"\n\t\t{\n\t\t\tmatrix4d xformOp:transform = ${r}\n\t\t\tuniform token[] xformOpOrder = ["xformOp:transform"]\n\n\t\t\tfloat2 clippingRange = (${t.near.toPrecision(Te)}, ${t.far.toPrecision(Te)})\n\t\t\tfloat focalLength = ${t.getFocalLength().toPrecision(Te)}\n\t\t\tfloat focusDistance = ${t.focus.toPrecision(Te)}\n\t\t\tfloat horizontalAperture = ${t.getFilmWidth().toPrecision(Te)}\n\t\t\ttoken projection = "perspective"\n\t\t\tfloat verticalAperture = ${t.getFilmHeight().toPrecision(Te)}\n\t\t}\n\t\n\t`}const be=.25,ve='\n<svg width="<WIDTH>px" height="<HEIGHT>px" viewBox="0 0 1024 256" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xml:space="preserve" xmlns:serif="http://www.serif.com/" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;">\n    <g transform="matrix(1.42378,0,0,-1.42378,37.8056,272.552)">\n        <path d="M535.902,111.141L535.902,135.996L516.129,135.996L516.129,40.18L535.902,40.18L535.902,90.087C540.364,74.698 554.364,63.505 570.884,63.505C589.267,63.505 604.519,77.36 607.001,95.441L607.245,97.219L607.245,64.239L626.512,64.239L626.555,66.149C630.504,64.457 634.803,63.668 638.946,63.657C644.567,63.523 650.034,65.021 655.057,68.061L660.825,71.553L651.44,88.59L645.161,84.719C643.29,83.566 641.189,83.086 639.101,83.077C632.262,83.174 627.017,88.662 627.017,95.331L627.017,135.997L607.245,135.997L607.245,101.756L597.204,104.413L607.131,108.728L604.463,115.117C598.904,128.43 585.948,137.724 570.884,137.724C554.364,137.724 540.364,126.53 535.902,111.141ZM515.693,52.455C515.693,60.117 509.874,63.947 504.055,63.947C498.236,63.947 492.417,60.117 492.417,52.455C492.417,37.14 515.693,37.14 515.693,52.455ZM380.282,71.383L380.282,153.041C379.771,153.655 373.607,159.525 373.258,160.065L373.258,135.997L348.352,135.997L348.243,134.69C344.015,136.642 339.458,137.674 335.553,137.747L335.511,137.748C324.933,137.821 315.829,134.433 309.296,128.08C305.974,124.851 303.277,120.825 301.442,115.998L301.442,135.996L273.142,135.996L273.142,97.898C273.142,94.483 272.775,90.902 269.308,90.902C265.617,90.902 263.827,94.498 263.827,98.131L263.827,135.996L235.53,135.996L235.53,98.131C235.53,94.53 234.463,90.671 230.75,90.671C227.046,90.671 225.511,94.483 225.511,98.131L225.511,135.996L197.213,135.996L197.213,64.239L223.485,64.239L223.627,65.183C226.918,63.895 230.419,63.307 233.669,63.307C240.087,63.307 246.447,65.139 251.31,69.669C256.803,65.062 263.137,63.54 270.002,63.54C280.598,63.54 288.388,67.088 293.646,73.141C296.904,76.89 299.223,81.729 300.443,87.587C302.282,81.374 305.504,76.323 309.651,72.435C316.294,66.207 325.463,62.891 335.799,62.957C340.05,62.961 344.191,63.842 347.897,65.413L347.96,64.36L399.852,64.36L400.044,66C404.335,64.016 408.962,63.073 413.227,63.073C426.457,63.073 437.04,68.986 443.35,78.274L443.35,64.239L455.619,64.239L455.619,48.113L475.273,46.066L475.273,64.239L494.056,64.239L494.056,64.005L513.822,64.005L513.822,135.996L494.056,135.996L494.056,132.579L492.809,133.184C488.173,135.434 483.508,136.813 478.88,136.813C471.929,136.813 466.942,134.899 463.359,131.901C458.177,127.565 455.619,120.504 455.619,111.217L455.619,83.076L446.093,83.076C448.504,88.174 449.807,93.997 449.807,100.235C449.807,121.049 436.525,137.4 413.692,137.4C410.081,137.4 405.736,136.78 401.557,135.338L401.557,160.065L373.258,160.065C374.058,159.226 379.595,153.754 380.282,153.041L394.533,153.041L394.533,122.196C398.624,128.502 407.623,130.376 413.692,130.376C432.149,130.376 442.783,117.06 442.783,100.235C442.783,83.299 430.977,70.096 413.227,70.096C406.687,70.096 398.975,72.899 394.533,79.326L393.603,71.383L380.282,71.383ZM528.878,128.972L528.878,47.203L523.153,47.203L523.153,128.972L528.878,128.972ZM508.669,52.455C508.669,55.493 506.362,57.011 504.055,57.011C501.748,57.011 499.441,55.493 499.441,52.455C499.441,46.383 508.669,46.383 508.669,52.455ZM468.249,71.263L468.249,53.859L462.643,54.443L462.643,71.263L450.374,71.263L450.374,76.053L462.643,76.053L462.643,111.217C462.643,122.546 466.615,129.789 478.88,129.789C482.497,129.789 486.12,128.623 489.744,126.865L487.757,122.196C484.837,123.597 481.684,124.532 478.88,124.532C469.888,124.532 468.249,119.041 468.249,111.217L468.249,76.053L487.874,76.053L487.874,71.263L468.249,71.263ZM368.25,71.383L354.58,71.383L354.11,79.326C350.841,73.601 343.484,69.981 335.776,69.981C318.955,69.864 305.75,80.26 305.75,100.118C305.75,120.329 318.371,130.842 335.421,130.725C341.848,130.604 350.841,127.336 354.11,120.565L354.813,128.973L368.25,128.973L368.25,71.383ZM242.554,98.131L242.554,128.972L256.803,128.972L256.803,98.131C256.803,90.537 261.593,83.878 269.308,83.878C277.013,83.878 280.166,90.308 280.166,97.898L280.166,128.972L294.418,128.972L294.418,97.898C294.418,80.608 286.36,70.563 270.002,70.563C262.53,70.563 255.869,72.899 250.729,81.077C247.456,73.136 240.567,70.33 233.669,70.33C228.184,70.33 221.525,72.43 218.487,78.273L217.436,71.263L204.237,71.263L204.237,128.972L218.487,128.972L218.487,98.131C218.487,90.538 223.038,83.648 230.75,83.648C238.581,83.648 242.554,90.537 242.554,98.131ZM548.355,110.081C552.002,119.128 560.713,125.5 570.884,125.5C580.946,125.5 589.582,119.266 593.296,110.373L597.982,112.41C593.492,123.162 583.05,130.7 570.884,130.7C554.619,130.7 541.435,117.229 541.435,100.614C541.435,83.998 554.619,70.528 570.884,70.528C585.747,70.528 598.036,81.778 600.043,96.397L595.072,97.712L595.066,97.66L548.346,110.06C548.347,110.063 548.348,110.065 548.349,110.067C548.35,110.07 548.351,110.072 548.352,110.075L548.323,110.083L548.355,110.081ZM619.645,71.263L619.877,81.547C623.495,73.714 631.678,70.68 639.037,70.68C643.363,70.564 647.56,71.733 651.42,74.07L648.847,78.74C645.815,76.871 642.42,76.053 639.037,76.053C628.285,76.174 619.993,84.816 619.993,95.331L619.993,128.973L614.269,128.973L614.269,71.263L619.645,71.263ZM501.08,71.029L501.08,128.972L506.798,128.972L506.798,71.029L501.08,71.029ZM570.884,75.728C557.432,75.728 546.525,86.87 546.525,100.615C546.525,101.951 546.631,103.261 546.829,104.54L593.773,92.08C590.364,82.54 581.403,75.728 570.884,75.728ZM337.058,117.641C327.596,117.641 320.003,111.095 320.003,100.118C320.003,89.139 327.596,82.712 337.058,82.712C359.486,82.712 359.486,117.641 337.058,117.641ZM554.337,95.28L582.868,87.708C579.76,84.644 575.542,82.752 570.884,82.752C563.085,82.752 556.533,88.04 554.337,95.28ZM494.056,119.062L491.343,112.685L484.719,115.864C482.789,116.789 480.733,117.508 478.88,117.508C477.629,117.508 476.693,117.588 476.133,117.047C475.69,116.618 475.657,115.939 475.534,115.219C475.328,114.012 475.273,112.666 475.273,111.217L475.273,83.076L494.056,83.076L494.056,119.062ZM428.531,100.235C428.531,91.24 422.455,83.878 412.176,83.878C401.893,83.878 395.818,91.24 395.818,100.235C395.818,109.227 402.479,116.593 412.176,116.593C421.876,116.593 428.531,109.227 428.531,100.235ZM337.058,110.617C343.68,110.617 346.855,105.333 346.855,100.176C346.855,95.02 343.68,89.735 337.058,89.735C331.452,89.735 327.027,93.613 327.027,100.118C327.027,106.637 331.439,110.617 337.058,110.617ZM421.507,100.235C421.507,95.103 418.041,90.902 412.176,90.902C406.308,90.902 402.842,95.103 402.842,100.235C402.842,105.366 406.643,109.569 412.176,109.569C417.711,109.569 421.507,105.366 421.507,100.235ZM587.073,107.048L586.815,107.666C584.171,113.998 578.048,118.476 570.884,118.476C566.637,118.476 562.757,116.902 559.752,114.299L587.073,107.048Z" style="fill-opacity:0.3;"/>\n    </g>\n    <g transform="matrix(1.42378,0,0,-1.42378,28.8272,275.975)">\n        <path d="M33.568,124.028C16.878,107.338 16.878,80.238 33.568,63.548L63.65,33.466C80.34,16.776 107.44,16.776 124.13,33.466L154.227,63.563C170.917,80.253 170.917,107.353 154.227,124.043L93.905,184.365L33.568,124.028ZM93.789,63.649L63.526,93.912L93.789,124.175L124.052,93.912L93.789,63.649Z" style="fill-opacity:0.3;"/>\n        <path d="M28.601,128.994C9.171,109.563 9.171,78.013 28.601,58.582L58.684,28.5C78.114,9.069 109.665,9.069 129.096,28.5L159.193,58.597C178.624,78.028 178.624,109.578 159.193,129.009L93.905,194.298L28.601,128.994ZM33.568,124.028C16.878,107.338 16.878,80.238 33.568,63.548L63.65,33.466C80.34,16.776 107.44,16.776 124.13,33.466L154.227,63.563C170.917,80.253 170.917,107.353 154.227,124.043L93.905,184.365L33.568,124.028ZM93.789,63.649L63.526,93.912L93.789,124.175L124.052,93.912L93.789,63.649ZM93.789,73.582L73.459,93.912L93.789,114.242L114.119,93.912L93.789,73.582Z" style="fill-opacity:0.3;"/>\n    </g>\n    <g transform="matrix(1.42378,0,0,-1.42378,37.8056,272.552)">\n        <path d="M528.878,128.972L528.878,47.203L523.153,47.203L523.153,128.972L528.878,128.972ZM508.669,52.455C508.669,58.53 499.441,58.53 499.441,52.455C499.441,46.383 508.669,46.383 508.669,52.455ZM501.08,71.029L501.08,128.972L506.798,128.972L506.798,71.029L501.08,71.029ZM468.249,71.263L468.249,53.859L462.643,54.443L462.643,71.263L450.374,71.263L450.374,76.053L462.643,76.053L462.643,111.217C462.643,122.546 466.615,129.789 478.88,129.789C482.497,129.789 486.12,128.623 489.744,126.865L487.757,122.196C484.837,123.597 481.684,124.532 478.88,124.532C469.888,124.532 468.249,119.041 468.249,111.217L468.249,76.053L487.874,76.053L487.874,71.263L468.249,71.263ZM368.25,71.383L354.58,71.383L354.11,79.326C350.841,73.601 343.484,69.981 335.776,69.981C318.955,69.864 305.75,80.26 305.75,100.118C305.75,120.329 318.371,130.842 335.421,130.725C341.848,130.604 350.841,127.336 354.11,120.565L354.813,128.973L368.25,128.973L368.25,71.383ZM337.058,117.641C327.596,117.641 320.003,111.095 320.003,100.118C320.003,89.139 327.596,82.712 337.058,82.712C359.486,82.712 359.486,117.641 337.058,117.641ZM242.554,98.131L242.554,128.972L256.803,128.972L256.803,98.131C256.803,90.537 261.593,83.878 269.308,83.878C277.013,83.878 280.166,90.308 280.166,97.898L280.166,128.972L294.418,128.972L294.418,97.898C294.418,80.608 286.36,70.563 270.002,70.563C262.53,70.563 255.869,72.899 250.729,81.077C247.456,73.136 240.567,70.33 233.669,70.33C228.184,70.33 221.525,72.43 218.487,78.273L217.436,71.263L204.237,71.263L204.237,128.972L218.487,128.972L218.487,98.131C218.487,90.538 223.038,83.648 230.75,83.648C238.581,83.648 242.554,90.537 242.554,98.131ZM380.282,153.041L380.282,71.383L393.603,71.383L394.533,79.326C398.975,72.899 406.687,70.096 413.227,70.096C430.977,70.096 442.783,83.299 442.783,100.235C442.783,117.06 432.149,130.376 413.692,130.376C407.623,130.376 398.624,128.502 394.533,122.196L394.533,153.041L380.282,153.041ZM428.531,100.235C428.531,91.24 422.455,83.878 412.176,83.878C401.893,83.878 395.818,91.24 395.818,100.235C395.818,109.227 402.479,116.593 412.176,116.593C421.876,116.593 428.531,109.227 428.531,100.235ZM619.645,71.263L619.877,81.547C623.495,73.714 631.678,70.68 639.037,70.68C643.363,70.564 647.56,71.733 651.42,74.07L648.847,78.74C645.815,76.871 642.42,76.053 639.037,76.053C628.285,76.174 619.993,84.816 619.993,95.331L619.993,128.973L614.269,128.973L614.269,71.263L619.645,71.263ZM548.355,110.081C552.002,119.128 560.713,125.5 570.884,125.5C580.946,125.5 589.582,119.266 593.296,110.373L597.982,112.41C593.492,123.162 583.05,130.7 570.884,130.7C554.619,130.7 541.435,117.229 541.435,100.614C541.435,83.998 554.619,70.528 570.884,70.528C585.747,70.528 598.036,81.778 600.043,96.397L595.072,97.712C595.07,97.7 595.069,97.689 595.068,97.677L595.066,97.66L548.346,110.06C548.347,110.063 548.348,110.065 548.349,110.067C548.35,110.07 548.351,110.072 548.352,110.075L548.323,110.083L548.355,110.081ZM570.884,75.728C557.432,75.728 546.525,86.87 546.525,100.615C546.525,101.951 546.631,103.261 546.829,104.54L593.773,92.08C590.364,82.54 581.403,75.728 570.884,75.728Z" style="fill:white;"/>\n    </g>\n    <g transform="matrix(1.42378,-1.58071e-16,-1.58071e-16,-1.42378,37.8056,272.552)">\n        <path d="M57.423,151.586C65.597,159.758 87.354,181.938 87.344,181.96C87.265,182.105 108.959,160.323 117.599,151.688L87.459,121.55L57.423,151.586Z" style="fill:rgb(58,24,136);fill-rule:nonzero;"/>\n        <path d="M87.459,121.55L117.598,151.688C117.643,151.638 117.698,151.581 117.747,151.536L147.857,121.424L117.72,91.287L87.459,121.55Z" style="fill:rgb(3,161,196);fill-rule:nonzero;"/>\n        <path d="M147.857,121.424L147.935,121.346C164.591,104.692 164.604,77.7 147.985,61.025L117.721,91.287L147.857,121.424Z" style="fill:rgb(5,208,223);fill-rule:nonzero;"/>\n        <path d="M57.195,91.287L27.164,121.317C27.173,121.328 27.178,121.338 27.189,121.347L57.373,151.536C57.39,151.552 57.408,151.568 57.423,151.586L87.459,121.55L57.195,91.287Z" style="fill:rgb(118,31,232);fill-rule:nonzero;"/>\n        <path d="M87.459,61.023L117.72,91.287L147.984,61.025C147.96,61.008 147.951,60.991 147.934,60.974L117.747,30.787C117.74,30.779 117.729,30.77 117.72,30.762L87.459,61.023Z" style="fill:rgb(255,170,1);fill-rule:nonzero;"/>\n        <path d="M27.037,61.129C10.529,77.804 10.571,104.696 27.164,121.318L57.195,91.288L27.037,61.129Z" style="fill:rgb(241,23,93);fill-rule:nonzero;"/>\n        <path d="M87.458,61.023L57.298,30.863L27.188,60.973C27.136,61.025 27.089,61.08 27.036,61.128L57.195,91.287L87.458,61.023Z" style="fill:rgb(251,58,27);fill-rule:nonzero;"/>\n        <path d="M117.722,30.761C101.046,14.116 74.039,14.125 57.374,30.787L57.3,30.863L87.46,61.023L117.722,30.761Z" style="fill:rgb(251,201,53);fill-rule:nonzero;"/>\n    </g>\n</svg>\n';function fs(t,e,r=256){return new Promise((s=>{const i=r*be,l=ve.replace("<WIDTH>",r.toString()).replace("<HEIGHT>",i.toString()),c=new Image,h=new Blob([l],{type:"image/svg+xml"}),u=URL.createObjectURL(h);c.onload=function(){t.drawImage(c,e,e),URL.revokeObjectURL(u),s()},c.src=u}))}function ps(t){return new Promise((e=>{const r=new FileReader;r.onloadend=()=>{typeof r.result=="string"?e(r.result):e("")},r.readAsDataURL(t)}))}const Ie="@maptiler/ar-control",_e="3.0.2";function fe(t){t.parentNode.removeChild(t)}const Re=12,Ae=512,Be=16;function xs(t){const e=document.createElement("canvas");e.width=t.width,e.height=t.height;const r=e.getContext("2d");if(!r)throw new Error("Unable to create a canvas with context.");const s=r.getImageData(0,0,t.width,t.height);return s.data.set(t.pixelData),r.putImageData(s,0,0),e}async function ws(t,e,r,s){const i=e.x-t.x+1,l=e.y-t.y+1,c=document.createElement("canvas");c.width=i*Ae,c.height=l*Ae;const h=c.getContext("2d");if(!h)throw new Error("The context is invalid");let u=0,p=0;const m=[];for(let i=t.y;i<=e.y;i+=1){for(let l=t.x;l<=e.x;l+=1){const t=s[~~(Math.random()*s.length)].replace("{x}",l.toString()).replace("{y}",i.toString()).replace("{z}",r.toString());m.push(Ls(t,h,[u*Ae,p*Ae])),u++}u=0,p++}return await Promise.all(m),c}function Ls(t,e,r){return new Promise((s=>{const i=new Image;i.crossOrigin="anonymous",i.src=t,i.onload=()=>{e.drawImage(i,r[0],r[1]),s()},i.onerror=()=>{s()}}))}function Cs(t,e,r){var s;const i=t[0],l=t[1],c=e[0],h=e[1],u=document.createElement("canvas");return u.width=c,u.height=h,(s=u.getContext("2d"))==null||s.drawImage(r,i,l,c,h,0,0,c,h),u}function ne(t){return new Promise((e=>{t.once("idle",(()=>{e(!0)}))}))}const Fe={showButton:!0,background:"#FFFFFF",closeButtonClassName:"",arButtonClassName:"",closeButtonContent:'<svg width="100%" height="100%" viewBox="0 0 33 33" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xml:space="preserve" xmlns:serif="http://www.serif.com/" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;">\n      <g transform="matrix(0.707107,0.707107,-0.707107,0.707107,16.6768,6.42373)">\n          <path d="M7,13.75C6.737,13.75 6.509,13.653 6.315,13.46C6.122,13.266 6.025,13.038 6.025,12.775L6.025,8.225L1.475,8.225C1.212,8.225 0.984,8.128 0.79,7.935C0.597,7.741 0.5,7.513 0.5,7.25C0.5,6.987 0.597,6.759 0.79,6.565C0.984,6.372 1.212,6.275 1.475,6.275L6.025,6.275L6.025,1.725C6.025,1.462 6.122,1.234 6.315,1.04C6.509,0.847 6.737,0.75 7,0.75C7.263,0.75 7.491,0.847 7.685,1.04C7.878,1.234 7.975,1.462 7.975,1.725L7.975,6.275L12.525,6.275C12.788,6.275 13.016,6.372 13.21,6.565C13.403,6.759 13.5,6.987 13.5,7.25C13.5,7.513 13.403,7.741 13.21,7.935C13.016,8.128 12.788,8.225 12.525,8.225L7.975,8.225L7.975,12.775C7.975,13.038 7.878,13.266 7.685,13.46C7.491,13.653 7.263,13.75 7,13.75Z" style="fill:rgb(68,73,82);fill-rule:nonzero;"/>\n      </g>\n    </svg>',arButtonContent:'\n  <span>\n    <svg width="33px" height="33px" viewBox="0 0 48 48" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xml:space="preserve" xmlns:serif="http://www.serif.com/" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2; vertical-align: middle;">\n      <g transform="matrix(0.718295,0,0,0.718295,6.75661,6.76523)">\n          <path d="M22.197,39.734L11.472,33.439C10.949,33.118 10.543,32.696 10.253,32.171C9.963,31.646 9.819,31.082 9.819,30.48L9.819,17.941C9.819,17.34 9.963,16.776 10.253,16.251C10.543,15.726 10.949,15.303 11.472,14.983L22.247,8.576C22.777,8.27 23.362,8.116 24,8.116C24.638,8.116 25.223,8.27 25.753,8.576L36.528,14.983C37.051,15.303 37.457,15.726 37.747,16.251C38.037,16.776 38.182,17.34 38.182,17.941L38.182,30.48C38.182,31.082 38.032,31.646 37.734,32.171C37.436,32.696 37.017,33.118 36.478,33.439L25.603,39.734C25.062,40.048 24.491,40.205 23.892,40.205C23.292,40.205 22.727,40.048 22.197,39.734ZM22.5,35.925L22.5,25.044L13.275,19.741L13.275,30.373L22.5,35.925ZM25.5,35.925L34.775,30.373L34.775,19.741L25.5,25.044L25.5,35.925ZM3.701,13.426L3.701,7.108C3.701,6.159 4.033,5.353 4.696,4.687C5.359,4.022 6.163,3.689 7.108,3.689L13.426,3.689L13.426,6.976L6.976,6.976L6.976,13.426L3.701,13.426ZM13.426,44.299L7.108,44.299C6.163,44.299 5.359,43.967 4.696,43.304C4.033,42.641 3.701,41.837 3.701,40.892L3.701,34.574L6.976,34.574L6.976,41.024L13.426,41.024L13.426,44.299ZM34.574,44.299L34.574,41.024L41.024,41.024L41.024,34.574L44.311,34.574L44.311,40.892C44.311,41.837 43.978,42.641 43.313,43.304C42.647,43.967 41.841,44.299 40.892,44.299L34.574,44.299ZM41.024,13.426L41.024,6.976L34.574,6.976L34.574,3.689L40.892,3.689C41.841,3.689 42.647,4.022 43.313,4.687C43.978,5.353 44.311,6.159 44.311,7.108L44.311,13.426L41.024,13.426ZM24,22.336L33.237,16.991L24,11.685L14.763,16.991L24,22.336Z" style="fill:rgb(36, 189, 240);fill-rule:nonzero;"/>\n      </g>\n    </svg>\n    <span style="vertical-align: middle;">\n    View in your space\n    </span>\n  </span>',edgeColor:"#7b8487",logo:"",activateAR:!1,highRes:!1},Oe={position:"absolute",bottom:"0",left:"0",right:"0",margin:"30px auto",fontSize:"1.4em",width:"fit-content",background:"#FFF",border:"1px solid #0000001a",borderRadius:"3px",padding:"2px 9px 2px 6px",color:"#727781","box-shadow":"0 0 6px 2px rgb(0 0 0 / 8%)"},Pe={position:"absolute",top:"0",right:"0",margin:"10px",padding:"0px",background:"#FFF",border:"none",borderRadius:"3px",width:"33px",height:"33px","box-shadow":"0 0 6px 2px rgb(0 0 0 / 8%)"};class Fs extends h{constructor(t={}){super();E(this,"controlButton");E(this,"controlButtonContainer");E(this,"map");E(this,"colorData",null);E(this,"landMaskData",null);E(this,"terrainData",null);E(this,"cameraSettings");E(this,"hasTerrain");E(this,"terrainExaggeration");E(this,"terrainSourceID");E(this,"meterPerPixelCenter",0);E(this,"originalPixelRatio",0);E(this,"mapCaptureBounds");E(this,"threeSceneGLTF");E(this,"threeSceneUSDZ");E(this,"threeTileContainerGLTF");E(this,"threeTileContainerUSDZ");E(this,"gltfMaterial");E(this,"usdzMaterial");E(this,"mapMeshGLTF");E(this,"mapMeshUSDZ");E(this,"itemsToDispose",[]);E(this,"gltfExporter",new ke);E(this,"lock",!1);E(this,"options");E(this,"arButton",null);E(this,"closeButton",null);E(this,"modelViewer",null);E(this,"logoImgElement",null);E(this,"logo");this.options={...Fe,...t},this.logo=t.logo}on(t,e){super.on(t,e)}once(t,e){super.once(t,e)}off(t){super.off(t)}onAdd(t){if(t.telemetry.registerModule(Ie,_e),this.setMap(t),this.controlButtonContainer=window.document.createElement("div"),this.options.showButton){this.controlButtonContainer.className="maplibregl-ctrl maplibregl-ctrl-group",this.controlButton=window.document.createElement("button"),this.controlButton.className="maptiler-ar-ctrl",this.controlButtonContainer.appendChild(this.controlButton);const t=window.document.createElement("span");t.className="maplibregl-ctrl-icon",t.setAttribute("aria-hidden","true"),this.controlButton.appendChild(t);const e='\n      <svg width="100%" height="100%" viewBox="0 0 48 48" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xml:space="preserve" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;">\n        <path d="M22.701,35.306L14.997,30.784C14.621,30.554 14.33,30.251 14.121,29.873C13.913,29.496 13.81,29.091 13.81,28.659L13.81,19.652C13.81,19.22 13.913,18.815 14.121,18.438C14.33,18.061 14.621,17.757 14.997,17.527L22.737,12.925C23.117,12.706 23.537,12.595 23.996,12.595C24.454,12.595 24.874,12.706 25.255,12.925L32.994,17.527C33.37,17.757 33.662,18.061 33.87,18.438C34.078,18.815 34.183,19.22 34.183,19.652L34.183,28.659C34.183,29.091 34.075,29.496 33.861,29.873C33.647,30.251 33.346,30.554 32.959,30.784L25.147,35.306C24.759,35.532 24.348,35.644 23.918,35.644C23.487,35.644 23.081,35.532 22.701,35.306ZM25.073,32.57L31.735,28.582L31.735,20.945L25.073,24.754L25.073,32.57ZM22.918,32.57L22.918,24.754L16.292,20.945L16.292,28.582L22.918,32.57ZM23.996,15.159L17.361,18.97L23.996,22.809L30.631,18.97L23.996,15.159Z" style="fill:rgb(68,73,82);"/>\n      </svg>\n      ',r='\n      <svg width="100%" height="100%" viewBox="0 0 48 48" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xml:space="preserve" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;">\n        <path d="M22.701,35.306L14.997,30.784C14.621,30.554 14.33,30.251 14.121,29.873C13.913,29.496 13.81,29.091 13.81,28.659L13.81,19.652C13.81,19.22 13.913,18.815 14.121,18.438C14.33,18.061 14.621,17.757 14.997,17.527L22.737,12.925C23.117,12.706 23.537,12.595 23.996,12.595C24.454,12.595 24.874,12.706 25.255,12.925L32.994,17.527C33.37,17.757 33.662,18.061 33.87,18.438C34.078,18.815 34.183,19.22 34.183,19.652L34.183,28.659C34.183,29.091 34.075,29.496 33.861,29.873C33.647,30.251 33.346,30.554 32.959,30.784L25.147,35.306C24.759,35.532 24.348,35.644 23.918,35.644C23.487,35.644 23.081,35.532 22.701,35.306ZM25.073,32.57L31.735,28.582L31.735,20.945L25.073,24.754L25.073,32.57ZM22.918,32.57L22.918,24.754L16.292,20.945L16.292,28.582L22.918,32.57ZM23.996,15.159L17.361,18.97L23.996,22.809L30.631,18.97L23.996,15.159Z" style="fill:rgb(68,73,82);"/>\n        <g transform="matrix(0.712957,0,0,0.712957,6.88903,6.88903)">\n            <path d="M13.45,44L7,44C6.175,44 5.469,43.706 4.881,43.119C4.294,42.531 4,41.825 4,41L4,34.55L7,34.55L7,41L13.45,41L13.45,44Z" style="fill:rgb(68,73,82);"/>\n        </g>\n        <g transform="matrix(0.712957,0,0,0.712957,6.88903,6.88903)">\n            <path d="M34.55,44L34.55,41L41,41L41,34.55L44,34.55L44,41C44,41.825 43.706,42.531 43.119,43.119C42.531,43.706 41.825,44 41,44L34.55,44Z" style="fill:rgb(68,73,82);"/>\n        </g>\n        <g transform="matrix(0.712957,0,0,0.712957,6.88903,6.88903)">\n            <path d="M4,13.45L4,7C4,6.175 4.294,5.469 4.881,4.881C5.469,4.294 6.175,4 7,4L13.45,4L13.45,7L7,7L7,13.45L4,13.45Z" style="fill:rgb(68,73,82);"/>\n        </g>\n        <g transform="matrix(0.712957,0,0,0.712957,6.88903,6.88903)">\n            <path d="M41,13.45L41,7L34.55,7L34.55,4L41,4C41.825,4 42.531,4.294 43.119,4.881C43.706,5.469 44,6.175 44,7L44,13.45L41,13.45Z" style="fill:rgb(68,73,82);"/>\n        </g>\n      </svg>\n      ';t.innerHTML=this.options.activateAR&&(bt||tt)?r:e,this.controlButton.type="button",this.controlButton.addEventListener("click",(async()=>{this.run()}))}return this.init3DScene(),this.controlButtonContainer}async run(){try{this.close()}catch{}if(this.lock)return;this.lock=!0,this.emit("computeStart"),await this.computeTextures();const t=this.getColorData(),e=this.getTerrainData();t&&e&&(await this.buildMapModel(),l.getPlatform()==="ios"?this.runNative():this.runMobile(),this.lock=!1)}onRemove(){var t;this.dispose(),(t=this.controlButtonContainer.parentNode)==null||t.removeChild(this.controlButtonContainer)}setMap(t){this.map=t}getMeterPerPixelCenter(){return this.meterPerPixelCenter}getColorData(){return this.colorData}getLandMaskData(){return this.landMaskData}getTerrainData(){return this.terrainData}saveMapSettings(){this.cameraSettings={center:this.map.getCenter(),zoom:this.map.getZoom(),pitch:this.map.getPitch(),bearing:this.map.getBearing()},this.terrainExaggeration=this.map.getTerrainExaggeration(),this.hasTerrain=this.map.hasTerrain(),this.originalPixelRatio=this.map.getPixelRatio(),this.hasTerrain&&(this.terrainSourceID=this.map.getTerrain().source)}restoreMapSettings(){this.map.triggerRepaint(),this.hasTerrain&&this.map.setTerrain({source:this.terrainSourceID,exaggeration:this.terrainExaggeration}),this.map.jumpTo(this.cameraSettings)}enableTopView(){this.saveMapSettings(),this.hasTerrain&&this.map.setTerrain(null),this.map.triggerRepaint();const t={center:this.cameraSettings.center,zoom:Math.min(this.cameraSettings.zoom,Be),pitch:0,bearing:0};this.map.jumpTo(t)}grabGlData(){const t=this.map.getCanvas().getContext("webgl2");if(!t)throw new Error("The WebGL context of the map is undefined");const e=new Uint8Array(t.drawingBufferWidth*t.drawingBufferHeight*4);return t.readPixels(0,0,t.drawingBufferWidth,t.drawingBufferHeight,t.RGBA,t.UNSIGNED_BYTE,e),{width:t.drawingBufferWidth,height:t.drawingBufferHeight,pixelData:e,bounds:this.map.getBounds()}}async computeColorData(){this.emit("startComputeColorData"),await ne(this.map),this.colorData=this.grabGlData(),this.emit("endComputeColorData",{})}async computeLandMaskData(){this.emit("startComputeLandMaskData",{}),this.map.addSource("xr_module_global_blackout_source",{type:"geojson",data:{type:"Feature",geometry:{type:"Polygon",coordinates:[[[-180,-90],[-180,90],[180,90],[180,-90],[-180,-90]]]}}}),this.map.addLayer({id:"xr_module_global_blackout_layer",type:"fill",source:"xr_module_global_blackout_source",layout:{},paint:{"fill-color":"#000","fill-opacity":1}}),this.map.addSource("xr_module_land_source",{type:"vector",url:"https://api.maptiler.com/tiles/land/tiles.json?key=bod4IIn9bwK8mnZIk49v"}),this.map.addLayer({id:"xr_module_land_layer",type:"fill",source:"xr_module_land_source","source-layer":"land",layout:{},paint:{"fill-color":"#fff","fill-opacity":1}}),await ne(this.map),this.landMaskData=this.grabGlData(),this.map.removeLayer("xr_module_global_blackout_layer"),this.map.removeLayer("xr_module_land_layer"),this.map.removeSource("xr_module_global_blackout_source"),this.map.removeSource("xr_module_land_source"),await ne(this.map),this.emit("endComputeLandMaskData",{})}async computeTerrainData_VIEWPORT(){this.emit("startComputeTerrainData",{}),this.map.addSource("xr_module_terrain_source",{type:"raster",url:"https://api.maptiler.com/tiles/terrain-rgb-v2/tiles.json"}),this.map.addLayer({id:"xr_module_terrain_layer",source:"xr_module_terrain_source",type:"raster",minzoom:0,layout:{visibility:"visible"},paint:{"raster-opacity":1},filter:["all"]}),await ne(this.map),this.terrainData=this.grabGlData(),this.map.removeLayer("xr_module_terrain_layer"),this.map.removeSource("xr_module_terrain_source"),await ne(this.map),this.emit("endComputeTerrainData",{})}async computeTerrainData(){var e;this.emit("startComputeTerrainData",{});const r=Math.min(Math.floor(this.map.getZoom()),Re),s=this.map.getBounds(),i=s.getNorth(),l=s.getSouth(),c=s.getEast(),h=s.getWest(),u=t.wgs84ToTileIndex([h,i],r,!1),p={x:u[0],y:u[1]},m={x:Math.floor(p.x),y:Math.floor(p.y)},d=t.wgs84ToTileIndex([c,l],r,!1),f={x:d[0],y:d[1]},g={x:Math.floor(f.x),y:Math.floor(f.y)},x=this.map.getSdkConfig(),w=this.map.getMaptilerSessionId(),L=await ws(m,g,r,[`https://api.maptiler.com/tiles/terrain-rgb-v2/{z}/{x}/{y}.webp?key=${x.apiKey}&mtsid=${w}&module=xr`]),y=[Math.floor(Ae*(p.x-m.x)),Math.floor(Ae*(p.y-m.y))],C=[Math.ceil(Ae*(f.x-p.x)),Math.ceil(Ae*(f.y-p.y))],M=Cs(y,C,L),T=(e=M.getContext("2d"))==null?void 0:e.getImageData(0,0,M.width,M.height).data;if(!T)throw new Error("Unable to extract terrain data.");this.terrainData={width:M.width,height:M.height,pixelData:new Uint8Array(T.buffer),bounds:s},this.emit("endComputeTerrainData",{})}async computeTextures(){var t;const r=this.map.getPixelRatio();if(this.options.highRes&&this.map.setPixelRatio(4),this.enableTopView(),await this.computeColorData(),await this.computeTerrainData(),!this.colorData)throw new Error("The color texture is invalid.");this.mapCaptureBounds=this.map.getBounds();const s=this.mapCaptureBounds.getCenter(),i=new e(this.mapCaptureBounds.getWest(),s.lat),l=new e(this.mapCaptureBounds.getEast(),s.lat).distanceTo(i);this.meterPerPixelCenter=l/((t=this.colorData)==null?void 0:t.width),this.options.highRes&&this.map.setPixelRatio(r),this.restoreMapSettings(),await ne(this.map)}init3DScene(){this.threeSceneGLTF=new u.Scene,this.threeTileContainerGLTF=new u.Object3D,this.threeSceneGLTF.add(this.threeTileContainerGLTF),this.threeTileContainerGLTF.rotation.set(-Math.PI/2,0,0),this.threeSceneUSDZ=new u.Scene,this.threeTileContainerUSDZ=new u.Object3D,this.threeSceneUSDZ.add(this.threeTileContainerUSDZ),this.threeTileContainerUSDZ.rotation.set(-Math.PI/2,0,0)}async buildMapModel(){if(!this.colorData)throw new Error("Color textures is not ready.");if(!this.terrainData)throw new Error("Terrain textures is not ready.");this.threeTileContainerGLTF.clear(),this.threeTileContainerUSDZ.clear(),this.dispose();const t=xs(this.colorData),r=t.getContext("2d");if(!r)throw new Error("Color texture not available");const s=new u.Color(this.options.edgeColor),i=s.clone().multiplyScalar(.65),l=s.clone().multiplyScalar(.5);r.fillStyle=`#${s.getHexString()}`;const c=Math.ceil(this.colorData.width/this.terrainData.width)*1.5;await fs(r,c*2,Math.max(256,t.width/10)),r.fillRect(0,0,t.width-1,c),r.fillRect(0,t.height-1-c,t.width-1,t.height-1),r.fillStyle=`#${i.getHexString()}`,r.fillRect(0,0,c,t.height-1),r.fillRect(t.width-1-c,0,t.width-1,t.height-1);const h=new u.CanvasTexture(t);h.flipY=!1,h.colorSpace=u.SRGBColorSpace,h.needsUpdate=!0,this.itemsToDispose.push(h),this.gltfMaterial=new u.MeshStandardMaterial({map:h,color:16777215}),this.usdzMaterial=new u.MeshStandardMaterial({map:h}),this.itemsToDispose.push(this.gltfMaterial),this.itemsToDispose.push(this.usdzMaterial);const p=this.mapCaptureBounds,m=new e(p.getWest(),p.getCenter().lat),d=p.getCenter(),f=new e(p.getEast(),p.getCenter().lat),g=m.distanceTo(d)+d.distanceTo(f),x=p.getSouthEast().distanceTo(p.getNorthEast()),w=new u.PlaneGeometry(g,x,this.terrainData.width-1,this.terrainData.height-1);this.mapMeshGLTF=new u.Mesh(w,this.gltfMaterial),this.mapMeshUSDZ=new u.Mesh(w,this.usdzMaterial);const L=w.attributes.position.array,y=this.terrainData.width,C=this.terrainData.height;let M=Number.POSITIVE_INFINITY;for(let t=0;t<L.length/3;t+=1){const e=this.terrainData.pixelData[t*4],r=this.terrainData.pixelData[t*4+1],s=this.terrainData.pixelData[t*4+2],i=(e*256*256+r*256+s)*.1-1e4;i<M&&(M=i)}const T=Be-1,b=Math.min(this.map.getZoom(),T);M-=50*(b-T)**2+30;for(let t=0;t<L.length/3;t+=1){const e=this.terrainData.pixelData[t*4],r=this.terrainData.pixelData[t*4+1],s=this.terrainData.pixelData[t*4+2];let i=(e*256*256+r*256+s)*.1-1e4-M;const l=t%y,c=~~(t/y);(l===0||c===0||l===y-1||c===C-1)&&(i=0),L[t*3+2]=i}w.computeVertexNormals(),this.itemsToDispose.push(w);const v=new u.PlaneGeometry(g,x,1,1),S=new u.MeshStandardMaterial({color:l}),I=new u.Mesh(v,S);I.rotateX(-Math.PI),this.itemsToDispose.push(v),this.itemsToDispose.push(S);const _=1/g;this.threeTileContainerGLTF.scale.x=_,this.threeTileContainerGLTF.scale.y=_,this.threeTileContainerGLTF.scale.z=_,this.threeTileContainerGLTF.add(this.mapMeshGLTF),this.threeTileContainerGLTF.add(I),this.threeTileContainerUSDZ.scale.x=_,this.threeTileContainerUSDZ.scale.y=_,this.threeTileContainerUSDZ.scale.z=_;const R=I.clone();this.threeTileContainerUSDZ.add(this.mapMeshUSDZ),this.threeTileContainerUSDZ.add(R)}dispose(){for(;this.itemsToDispose.length;){const t=this.itemsToDispose.pop();t==null||t.dispose()}}downloadGLTF(t=!1){this.threeTileContainerGLTF.updateMatrix(),this.threeTileContainerGLTF.updateMatrixWorld(),this.gltfExporter.parse(this.threeSceneGLTF,(e=>{let r;if(t)r=new Blob([e],{type:"application/octet-stream"});else{const t=JSON.stringify(e,null,2);r=new Blob([t],{type:"text/plain"})}const s=document.createElement("a");s.style.display="none",document.body.appendChild(s),s.href=URL.createObjectURL(r),s.download="maptiler_scene."+(t?"glb":"gltf"),s.click()}),(t=>{console.warn("error:",t)}),{binary:t,maxTextureSize:8192})}async downloadUSDZ(){this.threeTileContainerUSDZ.updateMatrix(),this.threeTileContainerUSDZ.updateMatrixWorld();const t=await this.getModelBlobUSDZ(),e=document.createElement("a");e.style.display="none",document.body.appendChild(e),e.href=URL.createObjectURL(t),e.download="maptiler_scene.usdz",e.click()}async getModelBlobGLB(){return new Promise(((t,e)=>{this.gltfExporter.parse(this.threeSceneGLTF,(e=>{const r=new Blob([e],{type:"application/octet-stream"});t(r)}),(t=>{e(t)}),{binary:!0,maxTextureSize:8192})}))}async getModelBlobUSDZ(){const t=await(new Yn).parse(this.threeSceneUSDZ,{maxTextureSize:8192});return new Blob([t],{type:"model/vnd.usdz+zip"})}async runNative(){this.threeTileContainerUSDZ.updateMatrix(),this.threeTileContainerUSDZ.updateMatrixWorld();const t=await this.getModelBlobUSDZ(),e=await ps(t),r=await s.writeFile({path:"some_mesh.usdz",directory:i.Cache,data:e});await c.open({filePath:r.uri,contentType:"model/vnd.usdz+zip",openWithDefault:!0}),this.emit("computeEnd")}async runMobile(){if(typeof window>"u")return;const t=this.map.getContainer(),e=await this.getModelBlobGLB(),s=URL.createObjectURL(e);if(this.modelViewer=new r,this.modelViewer.src=s,this.modelViewer.setAttribute("ar","true"),this.modelViewer.setAttribute("tone-mapping","commerce"),this.modelViewer.setAttribute("ar-modes","webxr quick-look"),this.modelViewer.setAttribute("camera-controls","true"),this.modelViewer.setAttribute("shadow-intensity","1"),this.modelViewer.style.width="100%",this.modelViewer.style.height="100%",this.modelViewer.style.zIndex="3",this.modelViewer.style.position="absolute",this.modelViewer.style.background=this.options.background,t.appendChild(this.modelViewer),this.arButton=document.createElement("button"),this.arButton.setAttribute("slot","ar-button"),this.arButton.id="maptiler-ar-enable-button",this.options.arButtonClassName)this.arButton.classList.add(this.options.arButtonClassName);else for(const t of Object.keys(Oe))this.arButton.style[t]=Oe[t];if(typeof this.options.arButtonContent=="string"?this.arButton.innerHTML=this.options.arButtonContent:this.arButton.appendChild(this.options.arButtonContent),this.modelViewer.appendChild(this.arButton),this.closeButton=document.createElement("button"),this.closeButton.id="maptiler-ar-close-button",this.options.closeButtonClassName)this.closeButton.classList.add(this.options.closeButtonClassName);else for(const t of Object.keys(Pe))this.closeButton.style[t]=Pe[t];typeof this.options.closeButtonContent=="string"?this.closeButton.innerHTML=this.options.closeButtonContent:this.closeButton.appendChild(this.options.closeButtonContent),this.modelViewer.appendChild(this.closeButton),this.closeButton.addEventListener("click",(async()=>{this.close()}));const i=this.createAttributionElement();i&&this.modelViewer.appendChild(i),this.logo&&(this.logoImgElement=document.createElement("img"),this.logoImgElement.src=this.logo,this.options.logoClass?this.logoImgElement.classList.add(this.options.logoClass):(this.logoImgElement.style.setProperty("position","absolute"),this.logoImgElement.style.setProperty("height",`${this.options.logoHeight??60}px`),this.logoImgElement.style.setProperty("width","auto"),this.logoImgElement.style.setProperty("bottom","0"),this.logoImgElement.style.setProperty("left","0"),this.logoImgElement.style.setProperty("bottom","0"),this.logoImgElement.style.setProperty("margin","10px")),this.modelViewer.appendChild(this.logoImgElement));let l=!1;this.options.activateAR?this.modelViewer.addEventListener("load",(async()=>{if(this.modelViewer.canActivateAR)try{await this.modelViewer.activateAR(),l=!0,setTimeout((()=>this.emit("computeEnd")),1e3)}catch{console.warn("AR to be automatically activated but failed."),this.emit("computeEnd")}else console.warn("AR cannot be automatically activated."),this.emit("computeEnd")})):this.emit("computeEnd"),this.modelViewer.addEventListener("camera-change",(t=>{l&&t.detail.source==="automatic"&&this.close()}))}close(){this.dispose(),fe(this.arButton),fe(this.modelViewer),fe(this.closeButton),this.logoImgElement&&fe(this.logoImgElement)}updateLogo(t){this.logoImgElement&&(this.logo=t,this.logoImgElement.src=t)}createAttributionElement(){const t=this.map._controls.filter((t=>t._attribHTML)).map((t=>t._attribHTML));if(!t.length)return null;const e=document.createElement("div");e.innerHTML=t[0],e.style.setProperty("font-family","12px / 20px Helvetica Neue, Arial, Helvetica, sans-serif"),e.style.setProperty("position","absolute"),e.style.setProperty("bottom",0),e.style.setProperty("right",0),e.style.setProperty("width","fit-content"),e.style.setProperty("height","fit-content"),e.style.setProperty("padding","1px 4px"),e.style.setProperty("font-size","12px"),e.style.setProperty("background","#FFFFFF80");const r=e.getElementsByTagName("a");for(const t of r)t.style.setProperty("color","#000000"),t.style.setProperty("text-decoration","none");return e}}export{Q as HAS_INTERSECTION_OBSERVER,J as HAS_RESIZE_OBSERVER,X as HAS_WEBXR_DEVICE_API,q as HAS_WEBXR_HIT_TEST_API,ot as IS_ANDROID,bt as IS_AR_QUICKLOOK_CANDIDATE,at as IS_CHROMEOS,ht as IS_FIREFOX,lt as IS_IOS,ft as IS_IOS_CHROME,gt as IS_IOS_SAFARI,it as IS_MOBILE,ut as IS_OCULUS,ct as IS_SAFARI,Lt as IS_SCENEVIEWER_CANDIDATE,tt as IS_WEBXR_AR_CANDIDATE,Tt as IS_WKWEBVIEW,Fs as MaptilerARControl,xs as mapTextureDataToCanvas};

